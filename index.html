<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WheelHouse - Options Strategy Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè†</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- ============================================================
         IMPORT MAP: ALL module versions defined in ONE place!
         To bust cache after changes, just bump the version here.
         ============================================================ -->
    <script type="importmap">
    {
        "imports": {
            "state": "./js/state.js",
            "charts": "./js/charts.js?v=1.19.92",
            "utils": "./js/utils.js?v=1.19.92",
            "api": "./js/api.js?v=1.19.92",
            "pricing": "./js/pricing.js?v=1.19.92",
            "simulation": "./js/simulation.js?v=1.19.92",
            "positions": "./js/positions.js?v=1.20.1",
            "portfolio": "./js/portfolio.js?v=1.20.1",
            "analysis": "./js/analysis.js?v=1.19.92",
            "challenges": "./js/challenges.js?v=1.19.92",
            "ui": "./js/ui.js?v=1.19.92",
            "settings": "./js/settings.js?v=1.19.92",
            "broker-import": "./js/broker-import.js?v=1.19.92",
            "schwab": "./js/schwab.js?v=1.19.92",
            "theme": "./js/theme.js?v=1.19.92",
            "formatters": "./js/utils/formatters.js?v=1.19.92",
            "AccountService": "./js/services/AccountService.js?v=1.19.92",
            "PositionsService": "./js/services/PositionsService.js?v=1.19.93",
            "StreamingService": "./js/services/StreamingService.js?v=1.20.1",
            "TradeCardService": "./js/services/TradeCardService.js?v=1.19.92",
            "WeeklySummaryService": "./js/services/WeeklySummaryService.js?v=1.19.92",
            "AlertService": "./js/services/AlertService.js?v=1.19.92",
            "SparkChartService": "./js/services/SparkChartService.js?v=1.19.92",
            "tradeStaging": "./js/tradeStaging.js?v=1.19.92",
            "aiHelpers": "./js/aiHelpers.js?v=1.19.92",
            "aiFunctions": "./js/aiFunctions.js?v=1.19.92",
            "positionCheckup": "./js/positionCheckup.js?v=1.19.92",
            "strategyAdvisor": "./js/strategyAdvisor.js?v=1.19.92",
            "monteCarlo": "./js/monteCarlo.js?v=1.19.92",
            "wheelScanner": "./js/wheelScanner.js?v=1.19.92",
            "pmccCalculator": "./js/pmccCalculator.js?v=1.19.92",
            "coach": "./js/coach.js?v=1.19.92"
        }
    }
    </script>
</head>
<body>
    <div class="container">
        <!-- Header: Logo left, Subtitle + Tabs right -->
        <div class="header-bar">
            <div class="header-logo">
                <h1>üè†<br>WheelHouse</h1>
            </div>
            <div class="header-right">
                <p class="subtitle">Wheel Strategy Options Analyzer</p>
                <div class="tabs">
                    <!-- Live Status Indicator -->
                    <div id="liveIndicator" style="display:inline-flex; align-items:center; margin-right:15px; padding:4px 10px; background:rgba(0,255,136,0.1); border-radius:6px; border:1px solid rgba(0,255,136,0.3);" title="App is running and connected">
                        <span class="pulse-dot" style="width:8px; height:8px; background:#00ff88; border-radius:50%; margin-right:6px; animation:pulse 2s infinite;"></span>
                        <span style="font-size:11px; color:#00ff88; margin-right:8px;">LIVE</span>
                        <span id="lastRefreshTime" style="font-size:10px; color:#888;">--:--:--</span>
                    </div>
                    <!-- Account Mode Switcher - Now with Multi-Account Support -->
                    <div style="display:inline-flex; align-items:center; margin-right:15px; padding:4px 8px; background:rgba(0,0,0,0.3); border-radius:6px; border:1px solid #333;" id="accountSwitcherHeader">
                        <span style="font-size:11px; color:#888; margin-right:6px;">Account:</span>
                        <select id="accountModeSelect" onchange="handleAccountChange(this.value)" style="font-size:12px; padding:4px 8px; background:#1a1a2e; color:#ddd; border:1px solid #333; border-radius:4px; cursor:pointer; min-width:160px;">
                            <option value="loading" disabled>Loading accounts...</option>
                        </select>
                        <button onclick="refreshAccountFromSchwab()" title="Sync positions from Schwab" style="margin-left:6px; padding:2px 8px; font-size:11px; background:rgba(0,217,255,0.15); color:#00d9ff; border:1px solid rgba(0,217,255,0.4); border-radius:4px; cursor:pointer;" id="syncAccountBtn">üîÑ Sync</button>
                        <button onclick="setPaperBalance()" title="Set Paper Trading Starting Balance" style="margin-left:4px; padding:2px 8px; font-size:11px; background:rgba(139,92,246,0.2); color:#b9f; border:1px solid rgba(139,92,246,0.5); border-radius:4px; cursor:pointer; display:none;" id="setPaperBalanceBtn">üíµ Set Balance</button>
                    </div>
                    <!-- Global AI Model Selector -->
                    <div style="display:inline-flex; align-items:center; margin-right:15px; padding:4px 8px; background:rgba(139,92,246,0.15); border-radius:6px; border:1px solid rgba(139,92,246,0.4);" id="globalAiSwitcher" title="Default AI model for all features. Individual panels can override.">
                        <span style="font-size:11px; color:#b9f; margin-right:6px;">üß† AI:</span>
                        <select id="globalAiModelSelect" onchange="saveGlobalAIModel()" style="font-size:12px; padding:4px 8px; background:#1a1a2e; color:#ddd; border:1px solid #6b46c1; border-radius:4px; cursor:pointer;">
                            <option value="qwen2.5:7b">Qwen 7B ‚≠ê</option>
                            <option value="qwen2.5:14b">Qwen 14B</option>
                            <option value="qwen2.5:32b">Qwen 32B</option>
                            <option value="deepseek-r1:32b">DeepSeek-R1 32B üßÆ</option>
                            <option value="llama3.1:8b">Llama 3.1 8B</option>
                            <option value="mistral:7b">Mistral 7B</option>
                            <option value="grok-3">üöÄ Grok-3</option>
                            <option value="grok-4" selected>üß† Grok-4</option>
                            <option value="grok-4-1-fast">‚ö° Grok 4.1 Fast</option>
                            <option value="grok-3-mini">üöÄ Grok-3 Mini</option>
                        </select>
                    </div>
                    <button class="tab-btn" data-tab="ideas" title="Trade Ideas: AI suggestions, Discord analyzer, wisdom management">üéØ Ideas</button>
                    <button class="tab-btn" data-tab="analyze" title="Pricing tools, Monte Carlo simulation, and Greeks calculator">üìä Analyze</button>
                    <button class="tab-btn" data-tab="pnl" title="Roll calculator and trade analysis">üí∞ P&L</button>
                    <button class="tab-btn active" data-tab="positions" title="Open positions with live pricing">üìã Positions</button>
                    <button class="tab-btn" data-tab="portfolio" title="Closed trades, P&L history, and analytics">üíº Portfolio</button>
                    <button class="tab-btn" data-tab="autonomous" title="Autonomous AI Trader - DeepSeek R1 + Grok powered">ü§ñ Auto</button>
                    <button class="tab-btn" data-tab="challenges" title="Trading challenges and goals">üèÜ</button>
                    <button class="tab-btn" data-tab="settings" title="API keys, broker integration, and preferences">‚öôÔ∏è Settings</button>
                    
                    <!-- Utility buttons group -->
                    <span style="display:inline-flex; align-items:center; margin-left:15px; gap:8px;">
                        <button onclick="window.open('docs/help.html', '_blank')" class="tab-btn" style="background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3);" title="Open Documentation">‚ùì Help</button>
                        <button id="restartServerBtn" onclick="restartServer()" class="tab-btn" style="background:rgba(180,120,60,0.3); border:1px solid rgba(180,120,60,0.5);" title="Restart Server">üîÑ Restart</button>
                        <button id="settingsBtn" onclick="showSettingsModal()" class="tab-btn" style="background:rgba(100,100,100,0.2); border:1px solid rgba(100,100,100,0.4);" title="Theme Settings">‚öôÔ∏è Theme</button>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Futures Ticker Strip -->
        <div id="futuresStrip" class="futures-strip" style="display:flex; align-items:center; gap:15px; padding:6px 15px; background:linear-gradient(135deg, rgba(0,0,0,0.6) 0%, rgba(26,26,46,0.8) 100%); border-bottom:1px solid #333; flex-wrap:wrap;">
            <span style="font-size:11px; color:#666; margin-right:5px;">üìà Futures:</span>
            <div data-futures-symbol="/ES" class="futures-tile" style="display:inline-flex; align-items:center; gap:8px; padding:4px 10px; background:rgba(0,217,255,0.1); border-radius:5px; border:1px solid rgba(0,217,255,0.2);">
                <span style="font-weight:bold; color:#00d9ff; font-size:12px;">S&P 500</span>
                <span class="futures-price" style="font-family:monospace; font-size:12px; color:#fff;">--</span>
                <span class="futures-change" style="font-size:11px;"></span>
                <span data-spark="/ES" class="spark-chart" title="15-min /ES history"></span>
            </div>
            <div data-futures-symbol="/NQ" class="futures-tile" style="display:inline-flex; align-items:center; gap:8px; padding:4px 10px; background:rgba(139,92,246,0.1); border-radius:5px; border:1px solid rgba(139,92,246,0.2);">
                <span style="font-weight:bold; color:#8b5cf6; font-size:12px;">Nasdaq</span>
                <span class="futures-price" style="font-family:monospace; font-size:12px; color:#fff;">--</span>
                <span class="futures-change" style="font-size:11px;"></span>
                <span data-spark="/NQ" class="spark-chart" title="15-min /NQ history"></span>
            </div>
            <div data-futures-symbol="/YM" class="futures-tile" style="display:inline-flex; align-items:center; gap:8px; padding:4px 10px; background:rgba(0,255,136,0.1); border-radius:5px; border:1px solid rgba(0,255,136,0.2);">
                <span style="font-weight:bold; color:#00ff88; font-size:12px;">Dow</span>
                <span class="futures-price" style="font-family:monospace; font-size:12px; color:#fff;">--</span>
                <span class="futures-change" style="font-size:11px;"></span>
                <span data-spark="/YM" class="spark-chart" title="15-min /YM history"></span>
            </div>
            <div data-futures-symbol="/RTY" class="futures-tile" style="display:inline-flex; align-items:center; gap:8px; padding:4px 10px; background:rgba(255,170,0,0.1); border-radius:5px; border:1px solid rgba(255,170,0,0.2);">
                <span style="font-weight:bold; color:#ffaa00; font-size:12px;">Russell</span>
                <span class="futures-price" style="font-family:monospace; font-size:12px; color:#fff;">--</span>
                <span class="futures-change" style="font-size:11px;"></span>
                <span data-spark="/RTY" class="spark-chart" title="15-min /RTY history"></span>
            </div>
            <button onclick="window.subscribeFutures()" style="margin-left:auto; padding:3px 10px; font-size:10px; background:rgba(0,217,255,0.2); color:#00d9ff; border:1px solid rgba(0,217,255,0.4); border-radius:4px; cursor:pointer;" title="Subscribe to real-time futures">‚ñ∂ Live</button>
            <span id="futuresStatus" style="font-size:10px; color:#666;">Disconnected</span>
        </div>

        <!-- Market Internals Strip -->
        <div id="marketInternalsStrip" class="internals-strip" style="display:flex; align-items:center; gap:15px; padding:8px 15px; background:linear-gradient(135deg, rgba(13,13,26,0.9) 0%, rgba(26,26,46,0.7) 100%); border-bottom:1px solid #333; flex-wrap:wrap;">
            <span style="font-size:12px; color:#888; margin-right:5px;" title="Market breadth and sentiment indicators">üìä Internals:</span>
            
            <!-- TICK - NYSE upticks minus downticks -->
            <div data-internal="$TICK" class="internal-tile" style="display:inline-flex; align-items:center; gap:8px; padding:5px 12px; background:rgba(0,217,255,0.1); border-radius:5px; border:1px solid rgba(0,217,255,0.25);">
                <span style="font-weight:bold; color:#00d9ff; font-size:12px;" title="NYSE TICK - Upticks minus downticks. Extreme: ¬±1000">TICK</span>
                <span class="internal-value" style="font-family:monospace; font-size:14px; font-weight:bold; color:#fff;">--</span>
                <span data-spark="$TICK" class="spark-chart" title="15-min TICK history"></span>
            </div>
            
            <!-- ADD - Advances minus Declines -->
            <div data-internal="$ADD" class="internal-tile" style="display:inline-flex; align-items:center; gap:8px; padding:5px 12px; background:rgba(0,255,136,0.1); border-radius:5px; border:1px solid rgba(0,255,136,0.25);">
                <span style="font-weight:bold; color:#00ff88; font-size:12px;" title="NYSE A/D Line - Advancing minus Declining stocks">A/D</span>
                <span class="internal-value" style="font-family:monospace; font-size:14px; font-weight:bold; color:#fff;">--</span>
                <span data-spark="$ADD" class="spark-chart" title="15-min A/D history"></span>
            </div>
            
            <!-- VOLD - Up Volume minus Down Volume -->
            <div data-internal="$VOLD" class="internal-tile" style="display:inline-flex; align-items:center; gap:8px; padding:5px 12px; background:rgba(139,92,246,0.1); border-radius:5px; border:1px solid rgba(139,92,246,0.25);">
                <span style="font-weight:bold; color:#8b5cf6; font-size:12px;" title="NYSE Volume Diff - Up volume minus Down volume (in millions)">VOL Œî</span>
                <span class="internal-value" style="font-family:monospace; font-size:14px; font-weight:bold; color:#fff;">--</span>
                <span data-spark="$VOLD" class="spark-chart" title="15-min Volume Œî history"></span>
            </div>
            
            <!-- TRIN - Arms Index -->
            <div data-internal="$TRIN" class="internal-tile" style="display:inline-flex; align-items:center; gap:8px; padding:5px 12px; background:rgba(255,170,0,0.1); border-radius:5px; border:1px solid rgba(255,170,0,0.25);">
                <span style="font-weight:bold; color:#ffaa00; font-size:12px;" title="Arms Index (TRIN) - <1.0 bullish, >1.0 bearish">TRIN</span>
                <span class="internal-value" style="font-family:monospace; font-size:14px; font-weight:bold; color:#fff;">--</span>
                <span data-spark="$TRIN" class="spark-chart" title="15-min TRIN history"></span>
            </div>
            
            <!-- VIX - Volatility Index -->
            <div data-internal="$VIX" class="internal-tile" style="display:inline-flex; align-items:center; gap:8px; padding:5px 12px; background:rgba(255,82,82,0.1); border-radius:5px; border:1px solid rgba(255,82,82,0.25);">
                <span style="font-weight:bold; color:#ff5252; font-size:12px;" title="CBOE Volatility Index - Fear gauge. >20 = elevated fear">VIX</span>
                <span class="internal-value" style="font-family:monospace; font-size:14px; font-weight:bold; color:#fff;">--</span>
                <span data-spark="$VIX" class="spark-chart" title="15-min VIX history"></span>
            </div>
            
            <!-- Market Mood Summary -->
            <div id="marketMood" style="margin-left:auto; display:inline-flex; align-items:center; gap:8px; padding:5px 14px; background:rgba(100,100,100,0.15); border-radius:5px; border:1px solid rgba(100,100,100,0.3);">
                <span style="font-size:12px; color:#aaa;">Mood:</span>
                <span id="moodIndicator" style="font-size:16px;">‚è≥</span>
                <span id="moodText" style="font-size:13px; font-weight:bold; color:#888;">Loading...</span>
            </div>
            
            <button onclick="window.refreshMarketInternals()" style="padding:5px 10px; font-size:11px; background:rgba(100,100,100,0.2); color:#aaa; border:1px solid rgba(100,100,100,0.3); border-radius:4px; cursor:pointer;" title="Refresh market internals">üîÑ</button>
            <span id="internalsStatus" style="font-size:10px; color:#555;">--</span>
        </div>

        <!-- IDEAS TAB (NEW) -->
        <div class="tab-content" id="ideas">
            <div class="main-grid">
                <div class="canvas-section">
                    <h3 style="color:var(--accent-cyan); margin-bottom:15px;">üéØ Trade Ideas & Analysis</h3>
                    
                    <!-- GPU Status Display -->
                    <div id="gpuStatus" style="font-size:11px; color:#888; margin-bottom:15px; padding:8px 12px; background:#0d0d1a; border-radius:6px; border:1px solid #333;">
                        üéÆ Detecting GPU...
                    </div>
                    
                    <!-- üîç WHEEL SCANNER - Find stocks near 3-month lows -->
                    <div style="background:linear-gradient(135deg, rgba(0,217,255,0.15) 0%, rgba(0,153,204,0.1) 100%); border:1px solid rgba(0,217,255,0.4); border-radius:10px; padding:18px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div>
                                <span style="color:#00d9ff; font-weight:bold; font-size:15px;">üîç Wheel Scanner</span>
                                <div style="font-size:11px; color:#0099cc; margin-top:2px;">Find oversold stocks near 3-month lows ‚Ä¢ Good wheel entry points</div>
                            </div>
                            <button id="scannerBtn" onclick="window.runWheelScanner()" class="btn-primary" style="padding:8px 16px; background:linear-gradient(135deg, #00d9ff 0%, #0099cc 100%); border:none; border-radius:6px; color:#000; font-weight:bold; cursor:pointer;" title="Scan for oversold stocks near 3-month lows - good wheel entry points">
                                üîÑ Scan Now
                            </button>
                        </div>
                        
                        <!-- Scanner Filters -->
                        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; color:#888;">
                                <span>Range:</span>
                                <select id="scannerMaxRange" style="background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px; font-size:11px;">
                                    <option value="5">‚â§5% from low</option>
                                    <option value="10" selected>‚â§10% from low</option>
                                    <option value="15">‚â§15% from low</option>
                                    <option value="20">‚â§20% from low</option>
                                    <option value="25">‚â§25% from low</option>
                                </select>
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; color:#888;">
                                <span>Sector:</span>
                                <select id="scannerSector" style="background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px; font-size:11px;">
                                    <option value="all">All Sectors</option>
                                    <option value="Tech">Tech</option>
                                    <option value="Fintech">Fintech</option>
                                    <option value="Crypto">Crypto</option>
                                    <option value="Space">Space</option>
                                    <option value="Defense">Defense</option>
                                    <option value="EV">EV</option>
                                    <option value="Energy">Energy</option>
                                    <option value="AI">AI</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Finance">Finance</option>
                                    <option value="ETF">ETFs</option>
                                    <option value="Gaming">Gaming</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Materials">Materials</option>
                                </select>
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; color:#888;">
                                <span>Cap:</span>
                                <select id="scannerCap" style="background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px; font-size:11px;">
                                    <option value="all">All Caps</option>
                                    <option value="Large">Large</option>
                                    <option value="Mid">Mid</option>
                                    <option value="Small">Small</option>
                                    <option value="ETF">ETF</option>
                                </select>
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; color:#888;">
                                <span>Price $</span>
                                <input type="number" id="scannerMinPrice" value="10" min="1" style="width:50px; background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px; font-size:11px;">
                                <span>-</span>
                                <input type="number" id="scannerMaxPrice" value="500" min="1" style="width:50px; background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px; font-size:11px;">
                            </label>
                        </div>
                        
                        <!-- Scanner Results -->
                        <div id="scannerResults" style="display:none;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span id="scannerCount" style="font-size:12px; color:#00d9ff; font-weight:bold;">0 candidates found</span>
                                <span id="scannerTime" style="font-size:10px; color:#666;"></span>
                            </div>
                            <div id="scannerTable" style="max-height:300px; overflow-y:auto; font-size:11px;">
                                <!-- Results populate here -->
                            </div>
                        </div>
                        
                        <!-- Scanner Loading -->
                        <div id="scannerLoading" style="display:none; text-align:center; padding:20px; color:#888;">
                            <div style="font-size:20px; margin-bottom:8px;">üîÑ</div>
                            <div>Scanning <span id="scannerProgress">0</span> tickers...</div>
                        </div>
                    </div>
                    
                    <!-- üéì AI Strategy Advisor - Recommends best strategy for any ticker -->
                    <div style="background:linear-gradient(135deg, rgba(147,51,234,0.15) 0%, rgba(79,70,229,0.1) 100%); border:1px solid rgba(147,51,234,0.4); border-radius:10px; padding:18px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div>
                                <span style="color:#a78bfa; font-weight:bold; font-size:15px;">üéì AI Strategy Advisor</span>
                                <a href="docs/help.html#strategy-advisor" target="_blank" class="help-link" title="Learn how the Strategy Advisor works">?</a>
                                <div style="font-size:11px; color:#8b5cf6; margin-top:2px;">Analyzes ALL strategies ‚Ä¢ Recommends the best one ‚Ä¢ Explains risks</div>
                            </div>
                            <select id="strategyAdvisorModel" style="font-size:11px; padding:4px 8px; background:#1a1a2e; color:#ddd; border:1px solid #6d28d9; border-radius:4px;">
                                <option value="qwen2.5:7b">Qwen 7B ‚ö°</option>
                                <option value="qwen2.5:14b">Qwen 14B</option>
                                <option value="qwen2.5:32b" selected>Qwen 32B üéØ</option>
                                <option value="deepseek-r1:32b">DeepSeek-R1 üßÆ</option>
                                <option value="grok-3">üöÄ Grok-3</option>
                                <option value="grok-4">üß† Grok-4</option>
                                <option value="grok-4-1-fast">‚ö° Grok 4.1 Fast</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-bottom:12px;">
                            <input type="text" id="strategyAdvisorTicker" placeholder="Enter ticker (e.g., PLTR, TSLA, NVDA)" 
                                style="flex:1; padding:10px 14px; background:#0d0d1a; border:1px solid #6d28d9; border-radius:6px; color:#fff; font-size:14px; text-transform:uppercase;"
                                onkeypress="if(event.key==='Enter') window.runStrategyAdvisor()">
                            <button onclick="window.runStrategyAdvisor()" class="btn-primary" style="padding:10px 20px; background:linear-gradient(135deg, #9333ea 0%, #6d28d9 100%); border:none; border-radius:6px; color:#fff; font-weight:bold; cursor:pointer;" title="AI analyzes all 6 strategies (sell put, covered call, SKIP, call spread, etc.) and recommends the best one for this ticker">
                                üîÆ Analyze All Strategies
                            </button>
                        </div>
                        <div style="display:flex; gap:15px; font-size:11px; color:#888; flex-wrap:wrap; align-items:center;">
                            <label style="display:flex; align-items:center; gap:4px;">
                                <span>Buying Power: $</span>
                                <input type="number" id="strategyAdvisorBP" value="25000" style="width:70px; background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px;">
                            </label>
                            <label style="display:flex; align-items:center; gap:4px;">
                                <span>Risk:</span>
                                <select id="strategyAdvisorRisk" style="background:#0d0d1a; border:1px solid #444; border-radius:4px; color:#ddd; padding:3px 6px;">
                                    <option value="conservative">Conservative</option>
                                    <option value="moderate" selected>Moderate</option>
                                    <option value="aggressive">Aggressive</option>
                                </select>
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; margin-left:auto; cursor:pointer;" title="Expert Mode: Gives AI full freedom to analyze and recommend any strategy. Best with Grok-4 or GPT-4 class models.">
                                <input type="checkbox" id="strategyAdvisorExpertMode" style="cursor:pointer;">
                                <span style="background:linear-gradient(90deg, #ffd700, #ff8c00); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:bold;">üèõÔ∏è Wall Street Mode</span>
                            </label>
                        </div>
                        <!-- Results now show in popup modal - no inline container needed -->
                    </div>
                    
                    <!-- Image Drop Zone for Broker Screenshots -->
                    <div id="imageDropZone" style="background:rgba(0,217,255,0.05); border:2px dashed rgba(0,217,255,0.3); border-radius:8px; padding:20px; margin-bottom:20px; text-align:center; cursor:pointer; transition:all 0.2s;"
                         ondragover="event.preventDefault(); this.style.borderColor='#00d9ff'; this.style.background='rgba(0,217,255,0.15)';"
                         ondragleave="this.style.borderColor='rgba(0,217,255,0.3)'; this.style.background='rgba(0,217,255,0.05)';"
                         ondrop="handleImageDrop(event)"
                         onclick="document.getElementById('imageUploadInput').click()">
                        <input type="file" id="imageUploadInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                        <div style="font-size:24px; margin-bottom:8px;">üì∑</div>
                        <div style="color:#00d9ff; font-weight:bold; margin-bottom:4px;">Drop Broker Screenshot Here</div>
                        <div style="color:#666; font-size:11px;">Or click to upload ‚Ä¢ Paste from clipboard with Ctrl+V</div>
                        <div id="imagePreview" style="margin-top:10px; display:none;">
                            <img id="previewImg" style="max-width:100%; max-height:150px; border-radius:6px; border:1px solid #333;">
                            <button onclick="parseUploadedImage(event)" style="margin-top:8px; padding:8px 16px; background:linear-gradient(135deg, #00d9ff 0%, #0099cc 100%); border:none; border-radius:6px; color:#000; font-weight:bold; cursor:pointer;" title="Use AI (Qwen2-VL) to extract trade details from broker screenshot">
                                üîç Extract Trade Details
                            </button>
                        </div>
                    </div>
                    
                    <!-- Image Parse Result -->
                    <div id="imageParseResult" style="display:none; background:rgba(122,138,148,0.1); border:1px solid rgba(122,138,148,0.3); border-radius:8px; padding:15px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="color:#8a9aa8; font-weight:bold;">üìã Extracted from Image</span>
                            <button onclick="document.getElementById('imageParseResult').style.display='none'" style="background:none; border:none; color:#888; cursor:pointer;">‚úï</button>
                        </div>
                        <div id="imageParseContent" style="font-family:monospace; font-size:12px; color:#ddd;"></div>
                        <button onclick="useExtractedTrade()" style="margin-top:10px; padding:8px 16px; background:#7a8a94; border:none; border-radius:6px; color:#fff; cursor:pointer;" title="Send extracted trade details to Discord analyzer for AI analysis">
                            ‚û°Ô∏è Send to Analyzer
                        </button>
                    </div>
                    
                    <!-- Discord Trade Analyzer (moved from Positions) -->
                    <div style="background:rgba(122,138,148,0.08); border:1px solid rgba(122,138,148,0.3); border-radius:8px; padding:15px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="color:#8a9aa8; font-weight:bold; font-size:14px;">üìã Paste Trade Callout</span>
                            <a href="docs/help.html#discord-analyzer" target="_blank" class="help-link" title="Learn how to use the Discord Analyzer">?</a>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <select id="discordModelSelect" style="font-size:11px; padding:4px 8px; background:#1a1a2e; color:#ddd; border:1px solid #444; border-radius:4px;" title="Override global model for Discord analysis">
                                    <option value="">(global)</option>
                                    <option value="qwen2.5:7b">7B ‚ö°</option>
                                    <option value="qwen2.5:14b">14B</option>
                                    <option value="qwen2.5:32b">32B</option>
                                    <option value="deepseek-r1:32b" selected>DeepSeek-R1 üßÆ</option>
                                    <option value="grok-3">üöÄ Grok-3</option>
                                    <option value="grok-4">üß† Grok-4 (Reasoning)</option>
                                    <option value="grok-4-1-fast">‚ö° Grok 4.1 Fast</option>
                                    <option value="grok-3-mini">üöÄ Grok Mini</option>
                                </select>
                                <button onclick="window.analyzeDiscordTrade()" class="btn-primary" style="padding:6px 14px;" title="AI analyzes the trade with live CBOE pricing and gives verdict (Aggressive/Moderate/Conservative)">üîç Analyze Trade</button>
                            </div>
                        </div>
                        <textarea id="pasteTradeInput" placeholder="Paste a trade from Discord, Twitter, or any callout...

Examples:
‚Ä¢ TSLA $400P Feb 27 for $3.75
‚Ä¢ Short put on PLTR $24 strike, March expiry
‚Ä¢ Bull put spread NVDA 120/110 for $2.50 credit" 
                            style="width:100%; height:100px; background:#0d0d1a; border:1px solid #333; border-radius:6px; color:#ddd; font-size:12px; padding:10px; resize:vertical; font-family:monospace;"></textarea>
                        <div style="font-size:10px; color:#666; margin-top:6px;">
                            ü§ñ AI parses any format: single legs, spreads, earnings plays. Uses live CBOE pricing.
                        </div>
                    </div>
                    
                    <!-- Pending Staged Trades -->
                    <div id="pendingTradesSection" style="margin-bottom:20px;">
                        <h4 style="color:#ffaa00; margin-bottom:10px;">‚è≥ Staged Trades (Pending Execution)</h4>
                        <div id="pendingTradesList"></div>
                    </div>
                    
                    <!-- Trading Wisdom Knowledge Base -->
                    <div style="background:rgba(34,197,94,0.08); border:1px solid rgba(34,197,94,0.3); border-radius:8px; padding:15px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="color:#22c55e; font-weight:bold; font-size:14px;">üìö Trading Wisdom</span>
                            <a href="docs/help.html#wisdom" target="_blank" class="help-link" title="Learn how the Wisdom System works">?</a>
                            <span id="wisdomCount" style="font-size:11px; color:#666;">0 entries</span>
                        </div>
                        
                        <!-- Image Drop Zone for Wisdom -->
                        <div id="wisdomImageDropZone" style="background:rgba(34,197,94,0.05); border:2px dashed rgba(34,197,94,0.3); border-radius:8px; padding:12px; margin-bottom:10px; text-align:center; cursor:pointer; transition:all 0.2s;"
                             ondragover="event.preventDefault(); this.style.borderColor='#22c55e'; this.style.background='rgba(34,197,94,0.15)';"
                             ondragleave="this.style.borderColor='rgba(34,197,94,0.3)'; this.style.background='rgba(34,197,94,0.05)';"
                             ondrop="handleWisdomImageDrop(event)"
                             onclick="document.getElementById('wisdomImageInput').click()">
                            <input type="file" id="wisdomImageInput" accept="image/*" style="display:none;" onchange="handleWisdomImageUpload(event)">
                            <div style="font-size:18px;">üì∑</div>
                            <div style="color:#22c55e; font-weight:bold; font-size:11px;">Drop Screenshot or Click to Upload</div>
                            <div style="color:#555; font-size:10px;">Discord/Twitter screenshots with trading advice</div>
                        </div>
                        <div id="wisdomImagePreview" style="margin-bottom:10px; display:none;">
                            <div style="position:relative; display:inline-block;">
                                <img id="wisdomPreviewImg" style="max-width:100%; max-height:100px; border-radius:6px; border:1px solid #22c55e;">
                                <button onclick="clearWisdomImage(event)" style="position:absolute; top:4px; right:4px; background:#ff5252; border:none; border-radius:50%; width:20px; height:20px; color:#fff; cursor:pointer; font-size:12px;">√ó</button>
                            </div>
                            <button onclick="window.extractWisdomFromImage()" style="margin-top:8px; padding:6px 12px; background:rgba(34,197,94,0.3); border:1px solid rgba(34,197,94,0.5); color:#22c55e; border-radius:6px; cursor:pointer; font-size:11px;" title="Use AI (Qwen2-VL) to extract text from trading advice screenshots">
                                üì∑ Extract Text from Image
                            </button>
                        </div>
                        <div id="wisdomExtractedPreview" style="display:none; background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.3); border-radius:6px; padding:10px; margin-bottom:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                <span style="color:#22c55e; font-weight:bold; font-size:11px;">üìã Extracted Text (edit if needed):</span>
                                <button onclick="document.getElementById('wisdomExtractedPreview').style.display='none'" style="background:none; border:none; color:#888; cursor:pointer;">√ó</button>
                            </div>
                            <div id="wisdomExtractedText" contenteditable="true" style="font-size:11px; color:#ddd; white-space:pre-wrap; min-height:40px; background:#0d0d1a; border-radius:4px; padding:8px;"></div>
                        </div>
                        
                        <textarea id="wisdomInput" placeholder="Paste trading advice from Discord, Twitter, or anywhere... or drop a screenshot above!

Examples:
‚Ä¢ Never roll a covered call more than 3 times
‚Ä¢ Close short puts at 50% profit
‚Ä¢ Don't sell CSPs into earnings week" 
                            style="width:100%; height:80px; background:#0d0d1a; border:1px solid #333; border-radius:6px; color:#ddd; font-size:12px; padding:10px; resize:vertical;"></textarea>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <button onclick="window.addWisdom()" class="btn-success" style="flex:1; padding:8px; font-size:12px; background:rgba(34,197,94,0.3); border:1px solid rgba(34,197,94,0.5); color:#22c55e;" title="AI extracts wisdom from your input and saves it with vector embeddings for semantic search">
                                üß† Process & Save
                            </button>
                            <button onclick="window.showWisdomList()" style="padding:8px 12px; font-size:12px; background:#1a1a2e; border:1px solid #333; color:#888; border-radius:4px; cursor:pointer;" title="View all stored wisdom entries with edit/delete options">
                                üìñ View All
                            </button>
                            <button onclick="window.testWisdomForType()" style="padding:8px 12px; font-size:12px; background:rgba(122,138,148,0.2); border:1px solid rgba(122,138,148,0.4); color:#8a9aa8; border-radius:4px; cursor:pointer;" title="See which wisdom applies to different position types">
                                üîç Test
                            </button>
                            <button onclick="window.regenerateWisdomEmbeddings()" style="padding:8px 12px; font-size:12px; background:rgba(147,51,234,0.2); border:1px solid rgba(147,51,234,0.4); color:#a78bfa; border-radius:4px; cursor:pointer;" title="Regenerate vector embeddings for all wisdom entries (needed if you edited existing entries)">
                                üîÑ Embeddings
                            </button>
                        </div>
                        <div style="font-size:10px; color:#666; margin-top:6px;">
                            AI extracts wisdom and includes it in future trade analysis
                        </div>
                    </div>
                    
                    <!-- AI Generated Ideas Results -->
                    <div id="ideaResultsLarge" style="display:none; background:#0d0d1a; border-radius:8px; padding:15px;">
                        <h4 style="color:#7a8a94; margin-bottom:10px;">üí° AI Trade Suggestions</h4>
                        <div id="ideaContentLarge" style="color:#ddd; font-size:13px; line-height:1.6; white-space:pre-wrap;"></div>
                    </div>
                </div>
                
                <div class="controls-panel">
                    <h3 style="color:#7a8a94; margin-bottom:15px;">üí° AI Trade Ideas Generator</h3>
                    
                    <div class="input-group" style="margin-bottom:12px;">
                        <label style="font-size:12px; color:#888;">Buying Power ($)</label>
                        <input type="number" id="ideaBuyingPower2" value="25000" min="1000" step="1000" 
                               style="width:100%; padding:10px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:6px; font-size:14px;">
                    </div>
                    
                    <div class="input-group" style="margin-bottom:12px;">
                        <label style="font-size:12px; color:#888;">Target Annual ROC (%)</label>
                        <input type="number" id="ideaTargetROC2" value="25" min="5" max="100" step="5"
                               style="width:100%; padding:10px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:6px; font-size:14px;">
                    </div>
                    
                    <div class="input-group" style="margin-bottom:12px;">
                        <label style="font-size:12px; color:#888;">Sectors to Avoid (optional)</label>
                        <input type="text" id="ideaSectorsAvoid2" placeholder="e.g., Tech, Energy"
                               style="width:100%; padding:10px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:6px; font-size:14px;">
                    </div>
                    
                    <div class="input-group" style="margin-bottom:15px;">
                        <label style="font-size:12px; color:#888;">AI Model</label>
                        <select id="ideaModelSelect2" style="width:100%; padding:10px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:6px; font-size:14px;">
                            <option value="qwen2.5:7b">Qwen 7B (Fast)</option>
                            <option value="qwen2.5:14b">Qwen 14B (Better)</option>
                            <option value="qwen2.5:32b">Qwen 32B</option>
                            <option value="deepseek-r1:32b" selected>DeepSeek-R1 32B (Best) üßÆ</option>
                            <option value="grok-3">üöÄ Grok-3 (Cloud - Fastest)</option>
                            <option value="grok-4">üß† Grok-4 (Reasoning)</option>
                            <option value="grok-4-1-fast">‚ö° Grok 4.1 Fast (Best)</option>
                            <option value="grok-3-mini">üöÄ Grok-3 Mini (Cloud)</option>
                        </select>
                    </div>
                    
                    <button id="ideaBtn2" class="btn-success" style="width:100%; padding:12px; font-size:14px; background:linear-gradient(135deg, #7a8a94 0%, #6a7a88 100%);" 
                            onclick="window.getTradeIdeas2()" title="AI generates trade ideas based on your buying power and portfolio constraints">
                        üí° Generate Trade Ideas
                    </button>
                    
                    <!-- X/Twitter Sentiment (Grok only) -->
                    <button id="xSentimentBtn2" class="btn-success" style="width:100%; margin-top:8px; padding:12px; font-size:14px; background:linear-gradient(135deg, #1da1f2 0%, #0d8ecf 100%); display:none;" 
                            onclick="window.getXSentiment()" title="Grok-3 searches X/Twitter for trending tickers with strong sentiment (bullish/bearish)">
                        üî• Trending on X (Grok)
                    </button>
                    
                    <!-- X Integration checkbox - shows after X Sentiment scan -->
                    <div id="xTickersOption2" style="display:none; margin-top:8px; padding:10px; background:rgba(29,161,242,0.1); border-radius:6px; border:1px solid rgba(29,161,242,0.3);">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:12px; color:#1da1f2;">
                            <input type="checkbox" id="useXTickers2" checked style="width:16px; height:16px; accent-color:#1da1f2;">
                            <span>Include <strong id="xTickerCount2">0</strong> X trending tickers in Ideas</span>
                        </label>
                    </div>
                    
                    <div style="margin-top:20px; padding:15px; background:rgba(0,217,255,0.1); border-radius:8px; border:1px solid rgba(0,217,255,0.2);">
                        <h4 style="color:#00d9ff; margin:0 0 8px; font-size:12px;">üí° How It Works</h4>
                        <ul style="color:#888; font-size:11px; margin:0; padding-left:16px; line-height:1.6;">
                            <li>AI scans wheel-friendly tickers</li>
                            <li>Filters by your buying power</li>
                            <li>Suggests strikes with good premium</li>
                            <li>Click any idea to Deep Dive</li>
                        </ul>
                    </div>
                    
                    <!-- Price Alerts Panel -->
                    <div style="margin-top:20px; padding:15px; background:rgba(255,170,0,0.1); border-radius:8px; border:1px solid rgba(255,170,0,0.3);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="color:#ffaa00; margin:0; font-size:12px;">üîî Price Alerts</h4>
                            <button onclick="window.requestAlertPermission()" style="background:none; border:none; color:#888; font-size:10px; cursor:pointer;" title="Enable browser notifications">üì¢ Enable</button>
                        </div>
                        <div id="alertsPanelContent" style="max-height:300px; overflow-y:auto;">
                            <div style="color:#888; padding:8px; text-align:center; font-size:12px;">
                                Loading alerts...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYZE TAB (combines Simulator, Options, Greeks) -->
        <div class="tab-content" id="analyze">
            <div class="sub-tabs" style="display:flex; gap:4px; margin-bottom:15px; padding:4px; background:#0d0d1a; border-radius:8px; width:fit-content;">
                <button class="sub-tab-btn active" data-subtab="analyze-pricing" onclick="switchSubTab('analyze', 'analyze-pricing')" title="Price options using Black-Scholes with live spot/IV data">üìà Pricing</button>
                <button class="sub-tab-btn" data-subtab="analyze-simulator" onclick="switchSubTab('analyze', 'analyze-simulator')" title="Monte Carlo simulation: 10,000 price paths to see win probability">üé≤ Monte Carlo</button>
                <button class="sub-tab-btn" data-subtab="analyze-greeks" onclick="switchSubTab('analyze', 'analyze-greeks')" title="Calculate Delta, Theta, Gamma, Vega for any option">Œî Greeks</button>
            </div>
            
            <!-- Pricing Sub-tab (formerly Options tab) -->
            <div class="sub-tab-content active" id="analyze-pricing">
                <!-- Will be populated by moving options content here -->
            </div>
            
            <!-- Monte Carlo Sub-tab (Risk Analysis) -->
            <div class="sub-tab-content" id="analyze-simulator">
                <div class="main-grid">
                    <div class="canvas-section">
                        <!-- Position Context for Monte Carlo -->
                        <div id="mcPositionBanner" style="display:none; background:rgba(122,138,148,0.15); border:2px solid #7a8a94; border-radius:6px; padding:10px 15px; margin-bottom:15px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <span style="color:#7a8a94; font-weight:bold;">üé≤ Analyzing: </span>
                                    <span id="mcPositionTicker" style="color:#fff; font-weight:bold;">‚Äî</span>
                                    <span id="mcPositionDetails" style="color:#888; margin-left:10px;">‚Äî</span>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <span style="color:#888; font-size:11px;">Paths:</span>
                                    <select id="mcPathCount" style="background:#1a1a2e; border:1px solid #333; color:#ddd; padding:4px 8px; border-radius:4px;">
                                        <option value="1000">1,000</option>
                                        <option value="5000">5,000</option>
                                        <option value="10000" selected>10,000</option>
                                        <option value="50000">50,000</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="mcNoPosition" style="text-align:center; padding:40px; color:#888;">
                            <div style="font-size:48px; margin-bottom:15px;">üé≤</div>
                            <h3 style="color:#8a9aa8; margin-bottom:10px;">Monte Carlo Risk Analysis</h3>
                            <p>Load a position from the <b>Positions</b> tab by clicking a risk badge,<br>
                            or set up a trade in <b>Pricing</b> first.</p>
                        </div>
                        
                        <h3 id="mcTitle" style="color:#7a8a94; margin-bottom:10px; display:none;">üìä Price Distribution at Expiry</h3>
                        <canvas id="mcDistributionCanvas" width="800" height="200" style="display:none;"></canvas>
                        
                        <h3 id="mcConeTitle" style="color:#7a8a94; margin:20px 0 10px; display:none;">üìà Probability Cone (Price Paths Over Time)</h3>
                        <canvas id="mcConeCanvas" width="800" height="200" style="display:none;"></canvas>
                        
                        <!-- Key Stats Grid -->
                        <div id="mcStatsGrid" class="stats-grid" style="display:none; margin-top:20px;">
                            <div class="stat-card" style="background:rgba(0,255,136,0.15)">
                                <div class="stat-value" id="mcOtmPct" style="color:#00ff88;">‚Äî</div>
                                <div class="stat-label">Expires OTM (Win)</div>
                            </div>
                            <div class="stat-card" style="background:rgba(255,82,82,0.15)">
                                <div class="stat-value" id="mcItmPct" style="color:#ff5252;">‚Äî</div>
                                <div class="stat-label">Expires ITM (Risk)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="mcMedianPrice">‚Äî</div>
                                <div class="stat-label">Median Price</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="mcExpectedMove">‚Äî</div>
                                <div class="stat-label">Expected Move</div>
                            </div>
                        </div>
                        
                        <!-- Percentile Table -->
                        <div id="mcPercentiles" style="display:none; margin-top:20px; background:#0d0d1a; border-radius:8px; padding:15px;">
                            <h4 style="color:#7a8a94; margin-bottom:10px;">üìä Price Percentiles at Expiry</h4>
                            <table style="width:100%; font-size:12px; color:#ddd;">
                                <tr style="color:#888;">
                                    <th style="text-align:left; padding:5px;">Percentile</th>
                                    <th>5%</th><th>10%</th><th>25%</th><th>50%</th><th>75%</th><th>90%</th><th>95%</th>
                                </tr>
                                <tr>
                                    <td style="padding:5px; color:#888;">Price</td>
                                    <td id="mcP5" style="text-align:center;">‚Äî</td>
                                    <td id="mcP10" style="text-align:center;">‚Äî</td>
                                    <td id="mcP25" style="text-align:center;">‚Äî</td>
                                    <td id="mcP50" style="text-align:center; color:#00d9ff; font-weight:bold;">‚Äî</td>
                                    <td id="mcP75" style="text-align:center;">‚Äî</td>
                                    <td id="mcP90" style="text-align:center;">‚Äî</td>
                                    <td id="mcP95" style="text-align:center;">‚Äî</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="controls-panel">
                        <h3 style="color:#7a8a94; margin-bottom:15px;">üé≤ Simulation Parameters</h3>
                        
                        <!-- Loaded Position Info -->
                        <div id="mcParamsBox" style="background:#0d0d1a; border-radius:8px; padding:12px; margin-bottom:15px; display:none;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px;">
                                <div><span style="color:#888;">Spot:</span> <span id="mcSpot" style="color:#00d9ff;">$‚Äî</span></div>
                                <div><span style="color:#888;">Strike:</span> <span id="mcStrike" style="color:#ffaa00;">$‚Äî</span></div>
                                <div><span style="color:#888;">IV:</span> <span id="mcIV" style="color:#8a9aa8;">‚Äî%</span></div>
                                <div><span style="color:#888;">DTE:</span> <span id="mcDTE">‚Äî days</span></div>
                            </div>
                        </div>
                        
                        <button id="runMcBtn" class="btn-primary" style="width:100%; padding:12px; font-size:14px; background:linear-gradient(135deg, #7a8a94 0%, #6a7a88 100%);"
                                onclick="window.runMonteCarloRisk()" title="Simulate 10,000 random price paths to see win probability and risk scenarios">
                            üé≤ Run Monte Carlo Simulation
                        </button>
                        
                        <div class="running" id="mcRunning" style="display:none;"><div class="spinner"></div>Simulating 10,000 paths...</div>
                        
                        <!-- Scenario Analysis -->
                        <div style="margin-top:20px; padding:15px; background:rgba(255,170,0,0.1); border-radius:8px; border:1px solid rgba(255,170,0,0.2);">
                            <h4 style="color:#ffaa00; margin:0 0 10px;">‚ö†Ô∏è Risk Scenarios</h4>
                            <div id="mcRiskScenarios" style="font-size:12px; color:#ddd; line-height:1.8;">
                                <div>Run simulation to see risk scenarios...</div>
                            </div>
                        </div>
                        
                        <!-- Profit Analysis -->
                        <div style="margin-top:15px; padding:15px; background:rgba(0,255,136,0.1); border-radius:8px; border:1px solid rgba(0,255,136,0.2);">
                            <h4 style="color:#00ff88; margin:0 0 10px;">üí∞ Profit Analysis</h4>
                            <div id="mcProfitAnalysis" style="font-size:12px; color:#ddd; line-height:1.8;">
                                <div>Run simulation to see profit analysis...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Greeks Sub-tab -->
            <div class="sub-tab-content" id="analyze-greeks">
                <!-- Will be populated by moving greeks content here -->
            </div>
        </div>

        <!-- OPTIONS TAB -->
        <div class="tab-content" id="options">
            <!-- Position Context Banner -->
            <div id="positionContext" style="display:none; background:rgba(0,217,255,0.15); border:2px solid var(--accent-cyan); border-radius:6px; padding:8px 12px; margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div style="color:var(--accent-cyan); font-weight:600; font-size:12px;">üìä ANALYZING POSITION</div>
                        <div id="contextTicker" style="font-weight:bold; color:#fff; font-size:14px;">‚Äî</div>
                        <div id="contextDetails" style="color:#888; font-size:12px;">‚Äî</div>
                    </div>
                    <button id="clearContextBtn" class="btn-secondary" style="padding:4px 8px; font-size:11px;" title="Clear loaded position context">‚úï Clear</button>
                </div>
            </div>
            
            <div class="options-layout">
                <!-- LEFT: Inputs -->
                <div class="options-inputs">
                    <div class="control-group">
                        <label>Ticker</label>
                        <div style="display:flex; gap:4px;">
                            <input type="text" id="tickerInput" placeholder="AAPL..." style="flex:1; padding:5px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:4px; color:#fff; text-transform:uppercase; font-size:12px;">
                            <button id="fetchTickerBtn" class="btn-secondary" style="padding:5px 8px; font-size:11px;" title="Fetch live spot price and IV from CBOE">üìä</button>
                        </div>
                        <div id="priceStatus" style="font-size:10px; color:#888; margin-top:2px;"></div>
                    </div>
                    
                    <div class="control-group">
                        <label>Spot (S‚ÇÄ) <input type="number" id="spotInput" class="value-input" min="1" max="1000" step="1" value="100"></label>
                        <input type="range" id="spotSlider" min="20" max="500" step="1" value="100">
                    </div>
                    <div class="control-group">
                        <label>Strike (K) <input type="number" id="strikeInput" class="value-input" min="1" max="1000" step="1" value="100"></label>
                        <input type="range" id="strikeSlider" min="20" max="500" step="1" value="100">
                    </div>
                    <div class="control-group">
                        <label>Lower Barrier <input type="number" id="lowerInput" class="value-input" min="1" max="500" step="1" value="80"></label>
                        <input type="range" id="lowerSlider" min="10" max="480" step="1" value="80">
                    </div>
                    <div class="control-group">
                        <label>Upper Barrier <input type="number" id="upperInput" class="value-input" min="1" max="1000" step="1" value="120"></label>
                        <input type="range" id="upperSlider" min="30" max="600" step="1" value="120">
                    </div>
                    <div class="control-group">
                        <label>Volatility (œÉ) <input type="number" id="optVolInput" class="value-input" min="5" max="200" step="1" value="20" style="width:40px;">%</label>
                        <input type="range" id="optVolSlider" min="0.05" max="1.5" step="0.01" value="0.2">
                    </div>
                    <div class="control-group">
                        <label>DTE <input type="number" id="dteInput" class="value-input" min="1" max="730" step="1" value="30"></label>
                        <input type="range" id="dteSlider" min="1" max="365" step="1" value="30">
                    </div>
                    <div class="control-group">
                        <label>üìÖ Expiry</label>
                        <input type="date" id="expiryDatePicker" style="width:100%; padding:4px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; font-size:11px;">
                        <div id="dteDisplay" style="font-size:11px; color:var(--accent-orange); margin-top:2px;"></div>
                    </div>
                    
                    <div style="display:flex; gap:6px; margin-top:10px; align-items:center;">
                        <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer;" title="Fetch live spot price and IV from CBOE before pricing">
                            <input type="checkbox" id="syncCheckbox" checked style="cursor:pointer;">
                            üì° Live
                        </label>
                        <button id="priceBtn" class="btn-primary" style="flex:2; padding:6px; font-size:12px;" title="Calculate call and put prices using Black-Scholes model">üíµ Price Options</button>
                    </div>
                    <div class="running" id="optRunning"><div class="spinner"></div>Pricing...</div>
                </div>
                
                <!-- CENTER: Charts -->
                <div class="options-charts">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <div id="positionInfo" style="font-size:11px;"></div>
                        <div id="tplusControl" style="display:flex; align-items:center; gap:4px; font-size:11px; color:#888;" title="Project P&L forward in time (T+0=today, T+1=tomorrow, etc.)">
                            <span>üìÖ</span>
                            <button onclick="window.setTplusDays((window.getTplusDays?.() || 0) - 1)" style="background:#1a1a2e; border:1px solid #444; color:#fff; padding:1px 6px; cursor:pointer; border-radius:3px; font-size:10px;" title="Decrease days">‚ñº</button>
                            <span id="tplusDisplay" style="min-width:32px; text-align:center; color:#00d9ff; font-weight:bold;">T+0</span>
                            <button onclick="window.setTplusDays((window.getTplusDays?.() || 0) + 1)" style="background:#1a1a2e; border:1px solid #444; color:#fff; padding:1px 6px; cursor:pointer; border-radius:3px; font-size:10px;" title="Increase days">‚ñ≤</button>
                        </div>
                    </div>
                    <canvas id="payoffCanvas" style="width:100%; height:220px;"></canvas>
                    <div class="legend" style="font-size:10px; margin:4px 0;">
                        <div class="legend-item"><div class="legend-color" style="background:var(--accent-green)"></div>Call</div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--accent-red)"></div>Put</div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--accent-cyan)"></div>Strike</div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--accent-orange)"></div>Barriers</div>
                    </div>
                    <canvas id="priceHistCanvas" style="width:100%; height:80px; margin-top:4px"></canvas>
                </div>
                
                <!-- RIGHT: Results -->
                <div class="options-results">
                    <div class="results-box options" style="margin-bottom:8px;">
                        <h3 style="font-size:12px; display:flex; justify-content:space-between; align-items:center;">
                            <span>üí∞ Option Prices</span>
                            <span id="priceSource" style="font-size:9px; color:#888;"></span>
                        </h3>
                        <div class="payoff-grid">
                            <div class="payoff-card call"><div class="payoff-label">CALL</div><div class="payoff-value" id="callPrice" title="Hover for bid/ask">‚Äî</div></div>
                            <div class="payoff-card put"><div class="payoff-label">PUT</div><div class="payoff-value" id="putPrice" title="Hover for bid/ask">‚Äî</div></div>
                        </div>
                        <div class="result-row"><span class="result-label">‚è±Ô∏è Time:</span><span class="result-value" id="optTau">‚Äî</span></div>
                        <div class="result-row"><span class="result-label">üìâ Below Strike:</span><span class="result-value put" id="optLower">‚Äî</span></div>
                        <div class="result-row"><span class="result-label">üìà Above Strike:</span><span class="result-value call" id="optUpper">‚Äî</span></div>
                    </div>
                    
                    <div id="recommendation" class="recommendation-box" style="display:none; margin-bottom:8px;">
                        <h3 id="recTitle" style="font-size:12px;">ü§ñ Recommendation</h3>
                        <div class="action" id="recAction" style="font-size:11px;"></div>
                        <div class="reason" id="recReason" style="font-size:11px;"></div>
                        <div class="tip" id="recTip" style="font-size:10px;"></div>
                    </div>
                    
                    <div class="results-box" id="worthItBox" style="display:none;">
                        <h3 style="font-size:12px;">üéØ Trade Metrics</h3>
                        <!-- Cost Basis Box (shown for covered calls with cost basis) -->
                        <div id="costBasisBox" style="display:none; margin-bottom:10px; padding:8px 10px; background:rgba(0,255,136,0.15); border:1px solid rgba(0,255,136,0.4); border-radius:6px; font-size:11px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="color:#aaa;">üìä Stock Cost Basis:</span>
                                <span id="costBasisValue" style="color:#0f8; font-weight:bold; font-size:13px;">‚Äî</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                                <span style="color:#aaa;">üí∞ If Called, Gain:</span>
                                <span id="gainIfCalledValue" style="font-weight:bold; font-size:13px;">‚Äî</span>
                            </div>
                        </div>
                        <div class="metrics-grid">
                            <div class="result-row"><span class="result-label">ROC:</span><span class="result-value" id="rocDisplay">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Annualized ROC:</span><span class="result-value" id="annRocDisplay">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Risk:Reward:</span><span class="result-value" id="riskRewardRatio">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Win Probability:</span><span class="result-value" id="winProbability">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Required Win Rate:</span><span class="result-value" id="requiredWinRate">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Your Edge:</span><span class="result-value" id="yourEdge">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Kelly %:</span><span class="result-value" id="kellyPct">‚Äî</span></div>
                        </div>
                        <div style="border-top:1px dashed rgba(255,255,255,0.2); margin-top:6px; padding-top:6px;">
                            <div class="result-row"><span class="result-label" title="Average stock price in Monte Carlo scenarios where you get assigned (stock ends below strike for puts)">Avg if Assigned:</span><span class="result-value" id="avgIfAssigned">‚Äî</span></div>
                            <div class="result-row"><span class="result-label" title="Average loss when assigned = (Strike - Avg Price - Premium) √ó 100 √ó Contracts. This is a realistic loss estimate based on simulation, not worst-case.">Expected Loss:</span><span class="result-value put" id="expectedLoss">‚Äî</span></div>
                        </div>
                    </div>
                    
                    <!-- Margin Impact Box -->
                    <div class="results-box" id="marginImpactBox" style="display:none; background:rgba(255,170,0,0.08); border:1px solid rgba(255,170,0,0.3);">
                        <h3 style="font-size:12px; color:#ffaa00;">üí≥ Margin Impact <span id="marginOptionType" style="font-weight:normal; color:#888;">(Short Put)</span></h3>
                        <div class="metrics-grid">
                            <div class="result-row"><span class="result-label" title="Margin requirement for this short option">Margin Required:</span><span class="result-value" id="marginRequired">‚Äî</span></div>
                            <div class="result-row"><span class="result-label" title="Your current buying power from Schwab">Your Buying Power:</span><span class="result-value" id="marginBuyingPower">‚Äî</span></div>
                            <div class="result-row"><span class="result-label" title="Buying power remaining after this trade">After Trade:</span><span class="result-value" id="marginAfterTrade">‚Äî</span></div>
                            <div class="result-row"><span class="result-label" title="What % of your buying power this trade uses">BP Utilization:</span><span class="result-value" id="marginUtilization">‚Äî</span></div>
                        </div>
                        <div id="marginVerdict" style="margin-top:8px; padding:6px 8px; border-radius:4px; font-size:11px; text-align:center;"></div>
                        <div id="marginCoveredNote" style="display:none; margin-top:6px; font-size:10px; color:#888; text-align:center;">üí° Covered calls don't require margin if you own the shares</div>
                    </div>
                    
                    <!-- What-If Scenario Calculator -->
                    <div class="results-box" id="whatIfBox" style="background:rgba(0,217,255,0.08); border:1px solid rgba(0,217,255,0.3);">
                        <h3 style="font-size:12px; color:#00d9ff;">üéØ What-If Scenario</h3>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;">
                            <div>
                                <label style="font-size:10px; color:#888;">Target Price</label>
                                <input type="number" id="whatIfPrice" step="0.01" placeholder="$92.00" 
                                    oninput="if(window.drawPayoffChart) window.drawPayoffChart()"
                                    style="width:100%; padding:6px; background:rgba(0,217,255,0.1); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; font-size:12px;">
                            </div>
                            <div>
                                <label style="font-size:10px; color:#888;">Target Date</label>
                                <input type="date" id="whatIfDate" 
                                    style="width:100%; padding:6px; background:rgba(0,217,255,0.1); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; font-size:12px;">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
                            <div>
                                <label style="font-size:10px; color:#888;">IV Assumption</label>
                                <input type="number" id="whatIfIV" step="1" placeholder="49" 
                                    style="width:100%; padding:6px; background:rgba(0,217,255,0.1); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; font-size:12px;">
                            </div>
                            <div style="display:flex; align-items:flex-end;">
                                <button onclick="window.calculateWhatIf()" 
                                    style="width:100%; padding:8px; background:#00d9ff; border:none; border-radius:4px; color:#000; font-weight:bold; cursor:pointer; font-size:11px;" title="Project option value at target price and date using Black-Scholes">
                                    ‚ñ∂ Calculate
                                </button>
                            </div>
                        </div>
                        <div id="whatIfResults" style="display:none; border-top:1px solid rgba(0,217,255,0.2); padding-top:8px; margin-top:4px;">
                            <div class="metrics-grid" style="font-size:11px;">
                                <div class="result-row"><span class="result-label">Projected Value:</span><span class="result-value" id="whatIfValue" style="color:#00ff88;">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">Current Value:</span><span class="result-value" id="whatIfCurrent">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">Gain/Loss:</span><span class="result-value" id="whatIfGain">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">Return:</span><span class="result-value" id="whatIfReturn">‚Äî</span></div>
                            </div>
                            <div style="border-top:1px dashed rgba(255,255,255,0.1); margin-top:6px; padding-top:6px; font-size:10px; color:#888;">
                                <div style="display:flex; justify-content:space-between;"><span>Intrinsic:</span><span id="whatIfIntrinsic">‚Äî</span></div>
                                <div style="display:flex; justify-content:space-between;"><span>Time Value:</span><span id="whatIfTimeValue">‚Äî</span></div>
                                <div style="display:flex; justify-content:space-between;"><span>Remaining DTE:</span><span id="whatIfDTE">‚Äî</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P&L TAB - New Wide Layout -->
        <div class="tab-content" id="pnl">
            <div class="pnl-layout">
                <!-- LEFT: Charts (narrower) -->
                <div class="pnl-charts">
                    <h3 style="color:var(--accent-cyan); margin-bottom:4px; font-size:13px;">üí∞ P&L at Expiration</h3>
                    <canvas id="pnlCanvas" width="600" height="120"></canvas>
                    
                    <h3 style="color:var(--accent-cyan); margin:8px 0 4px; font-size:13px;">üìä Probability Cone</h3>
                    <canvas id="probConeCanvas" width="600" height="110"></canvas>
                    
                    <div style="display:flex; align-items:center; gap:10px; margin:8px 0 4px;">
                        <h3 style="color:var(--accent-cyan); margin:0; font-size:13px;">üî• Heat Map</h3>
                        <div style="display:flex; align-items:center; gap:6px; margin-left:auto;">
                            <label style="font-size:12px; color:var(--accent-orange);">Spot $</label>
                            <input type="number" id="heatMapSpot" class="value-input" step="0.01" style="width:70px; padding:4px;">
                            <button id="heatMapFetchBtn" class="btn-secondary" style="padding:4px 8px; font-size:11px;" title="Fetch live price">üìä</button>
                            <button id="heatMapUpdateBtn" class="btn-primary" style="padding:4px 10px; font-size:11px;">Update</button>
                        </div>
                    </div>
                    <canvas id="heatMapCanvas" width="600" height="120"></canvas>
                    
                    <!-- Break-Even Analysis -->
                    <div class="results-box" style="padding:10px; margin-top:10px;">
                        <h3 style="font-size:13px; margin-bottom:8px;">üìä Break-Even Analysis</h3>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <div class="result-row" style="padding:4px 0; font-size:13px;"><span class="result-label">Break-Even:</span><span class="result-value" id="breakEvenPrice">‚Äî</span></div>
                            <div class="result-row" style="padding:4px 0; font-size:13px;"><span class="result-label">Max Profit:</span><span class="result-value call" id="maxProfit">‚Äî</span></div>
                            <div class="result-row" style="padding:4px 0; font-size:13px;"><span class="result-label">Max Loss:</span><span class="result-value put" id="maxLoss">‚Äî</span></div>
                            <div class="result-row" style="padding:4px 0; font-size:13px;"><span class="result-label">Expected Value:</span><span class="result-value" id="expectedValue">‚Äî</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- MIDDLE: Roll Calculator & Suggestions -->
                <div class="pnl-roll-calc">
                    <!-- PMCC Calculator Button -->
                    <button onclick="window.openPMCCCalculator()" 
                            style="width:100%; padding:8px; margin-bottom:12px; background:linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border:none; border-radius:6px; color:#fff; font-weight:bold; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; gap:6px;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(139,92,246,0.4)';" 
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';'
                            title="Poor Man's Covered Call: Buy LEAPS call, sell shorter-dated calls against it">
                        <span>üìä</span>
                        <span>PMCC Calculator</span>
                        <span style="font-size:10px; opacity:0.8;">(Poor Man's Covered Call)</span>
                    </button>
                    
                    <h3 style="color:var(--accent-green); margin-bottom:8px; font-size:13px;">üîÑ Roll Calculator <a href="docs/help.html#roll-calculator" target="_blank" class="help-link" title="Learn how to use the Roll Calculator">?</a></h3>
                    
                    <!-- Current Position Info - Compact -->
                    <div style="background:rgba(255,170,0,0.15); padding:8px; border-radius:4px; margin-bottom:10px; font-size:12px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:3px;">
                            <span>Strike: $<span id="rollCurrentStrike">‚Äî</span></span>
                            <span>DTE: <span id="rollCurrentDte">‚Äî</span>d</span>
                            <span>Risk: <span id="rollCurrentRisk">‚Äî</span>%</span>
                            <span>Prem: $<span id="rollCurrentPremium">‚Äî</span></span>
                        </div>
                    </div>
                    
                    <!-- Roll Inputs - Compact 4-col -->
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:6px; margin-bottom:8px;">
                        <div class="control-group">
                            <label style="font-size:10px;">Strike</label>
                            <select id="rollNewStrike" class="value-input" style="width:100%; padding:5px; font-size:11px; background:#0d0d1a; border:1px solid #333; color:#fff; cursor:pointer;">
                                <option value="95">$95 (click ‚ú®)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label style="font-size:10px;">DTE</label>
                            <input type="number" id="rollNewDte" class="value-input" min="1" max="365" step="1" value="45" style="width:100%; padding:5px; font-size:12px;">
                        </div>
                        <div class="control-group">
                            <label style="font-size:10px;">üìÖ Expiry</label>
                            <input type="date" id="rollNewExpiry" style="width:100%; padding:5px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; font-size:11px;">
                        </div>
                        <div class="control-group">
                            <label style="font-size:10px;">Cr/Dr $</label>
                            <input type="number" id="rollCredit" class="value-input" min="-10000" max="10000" step="1" value="50" style="width:100%; padding:5px; font-size:12px;" title="Total. Negative = debit">
                        </div>
                    </div>
                    <div style="display:flex; gap:6px; margin-bottom:6px;">
                        <button id="rollBtn" class="btn-primary" style="flex:1; padding:6px; font-size:12px;" title="Calculate net credit/debit and metrics for this roll">üßÆ Calc</button>
                        <button id="suggestRollBtn" class="btn-primary" style="flex:1; padding:6px; font-size:12px; background:linear-gradient(135deg, #7a8a94, #6a7a88);" title="AI suggests optimal roll strikes based on current market conditions">‚ú® Suggest</button>
                    </div>
                    
                    <!-- IV Summary Bar -->
                    <div id="rollIvSummary" style="display:none; background:rgba(0,217,255,0.1); padding:6px 10px; border-radius:4px; margin-bottom:8px; font-size:11px;">
                        <span style="color:#888; cursor:help;" title="Implied Volatility - How 'expensive' premiums are. Higher IV = fatter premiums but more volatile stock.">IV: ‚ÑπÔ∏è</span>
                        <span id="rollIvDisplay" style="color:#00d9ff; font-weight:bold; margin-left:4px;">-</span>
                        <span id="rollIvContext" style="color:#666; margin-left:8px; font-size:10px;"></span>
                    </div>
                    
                    <!-- Roll Results - Compact -->
                    <div id="rollResults" style="padding:8px; background:rgba(0,0,0,0.3); border-radius:4px; font-size:12px; margin-bottom:10px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:4px; font-size:11px;">
                            <div class="result-row"><span class="result-label">Strike</span><span class="result-value" id="rollNewStrikeDisp">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">DTE</span><span class="result-value" id="rollNewDteDisp">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Risk</span><span class="result-value put" id="rollNewRisk">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Prem</span><span class="result-value call" id="rollTotalPremium">‚Äî</span></div>
                        </div>
                        <div class="result-row" style="margin-top:6px; padding-top:6px; border-top:1px solid #333; display:flex; justify-content:space-between;">
                            <span class="result-label">Net Result:</span>
                            <span class="result-value" id="rollNetCredit" style="font-size:14px; font-weight:bold;">‚Äî</span>
                        </div>
                        <div id="rollComparison" style="margin-top:6px; padding:6px; background:rgba(0,217,255,0.15); border-radius:4px; font-size:11px; color:#888;">Click Calculate or pick a suggestion</div>
                    </div>
                    
                    <!-- Suggestions -->
                    <div id="rollSuggestions" style="display:none; padding:8px; background:rgba(122,138,148,0.15); border:1px solid rgba(122,138,148,0.3); border-radius:4px; font-size:11px;">
                        <div style="color:#7a8a94; font-weight:bold; margin-bottom:6px; font-size:12px;">‚ú® Roll Suggestions</div>
                        <div id="rollSuggestionsList"></div>
                    </div>
                </div>
                
                <!-- RIGHT: Expert Analysis -->
                <div class="pnl-expert">
                    <h3 style="color:var(--accent-orange); margin-bottom:8px; font-size:13px;">ü§ñ Expert Analysis</h3>
                    <div id="expertAnalysis">
                        <div style="color:#888; font-size:12px; padding:15px; text-align:center;">
                            Load a position and click<br><b>‚ú® Suggest</b> to see analysis
                        </div>
                    </div>
                    
                    <!-- AI Insights (Ollama) -->
                    <div id="aiInsightsPanel" style="margin-top:12px; padding:10px; background:rgba(0,217,255,0.08); border:1px solid rgba(0,217,255,0.3); border-radius:6px; max-height:400px; overflow-y:auto;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="color:var(--accent-cyan); font-weight:bold; font-size:12px;">üß† AI Trade Advisor</span>
                            <a href="docs/help.html#ai-trade-advisor" target="_blank" class="help-link" title="Learn how the AI Trade Advisor works">?</a>
                            <button id="aiInsightBtn" onclick="getAIInsight()" class="btn-mini" style="font-size:10px; padding:3px 8px;" title="Get AI recommendation (HOLD/ROLL/CLOSE) with reasoning and risk analysis">üí° Get Insight</button>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                            <label style="font-size:10px; color:#666;" title="Override the global AI model for this panel only">Override:</label>
                            <select id="aiModelSelect" onchange="saveAIModelPreference()" style="font-size:10px; padding:2px 4px; background:#1a1a2e; color:#ddd; border:1px solid #444; border-radius:3px;" title="Leave empty to use global model">
                                <option value="" selected>(use global)</option>
                                <option value="qwen2.5:7b">Qwen 7B ‚≠ê</option>
                                <option value="qwen2.5:14b">Qwen 14B</option>
                                <option value="qwen2.5:32b">Qwen 32B</option>
                                <option value="deepseek-r1:32b">DeepSeek-R1 32B üßÆ</option>
                                <option value="llama3.1:8b">Llama 3.1 8B</option>
                                <option value="mistral:7b">Mistral 7B</option>
                                <option value="grok-3">üöÄ Grok-3 (Cloud)</option>
                                <option value="grok-4">üß† Grok-4 (Reasoning)</option>
                                <option value="grok-4-1-fast">‚ö° Grok 4.1 Fast</option>
                                <option value="grok-3-mini">üöÄ Grok-3 Mini</option>
                            </select>
                            <button id="aiWarmupBtn" onclick="warmupAIModel()" style="font-size:9px; padding:2px 6px; background:#333; color:#888; border:1px solid #444; border-radius:3px; cursor:pointer;" title="Pre-load model into GPU memory">üî• Warmup</button>
                            <span id="aiModelStatus" style="font-size:9px; color:#666;"></span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <label style="font-size:10px; color:#888; display:flex; align-items:center; gap:4px; cursor:pointer;" title="When ON, AI follows your trading rules from the Wisdom tab. When OFF, get raw AI analysis without rule influence.">
                                <input type="checkbox" id="aiWisdomToggle" checked onchange="saveWisdomPreference()" style="margin:0; cursor:pointer;">
                                <span>üìö Apply Wisdom</span>
                            </label>
                            <span id="wisdomStatus" style="font-size:9px; color:#4ade80;">‚úì Rules active</span>
                        </div>
                        <div id="aiInsightContent" style="color:#aaa; font-size:11px; line-height:1.5;">
                            Click <b>Get Insight</b> after clicking <b>‚ú® Suggest</b> to get AI-powered trade recommendations.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- POSITIONS TAB -->
        <div class="tab-content active" id="positions">
            <div class="main-grid">
                <div class="canvas-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="color:var(--accent-cyan); margin:0;">üìã Your Open Positions <a href="docs/help.html#positions" target="_blank" class="help-link" title="Learn about the Positions tab">?</a></h3>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <span id="autoSaveStatus" style="font-size:10px; color:#666; padding:6px 8px;">‚ö™ Auto-save OFF</span>
                            <button onclick="setupAutoSave()" class="btn-toolbar" title="Pick a file location for automatic saving">üíæ Enable Auto-save</button>
                            <button onclick="window.showReconcileModal()" class="btn-toolbar" title="Compare your positions with Schwab transactions">üîÑ Reconcile</button>
                            <button onclick="exportAllData()" class="btn-toolbar" title="Export all positions and history to JSON file">üì§ Export</button>
                            <label class="btn-toolbar" style="cursor:pointer;">
                                üì• Import
                                <input type="file" id="importFileInput" accept=".json" onchange="importAllData(event)" style="display:none;">
                            </label>
                            <button onclick="showBrokerImportModal()" class="btn-toolbar btn-accent" title="Import from broker export (Schwab, etc.)">üè¶ From Broker</button>
                        </div>
                    </div>
                    <div id="positionsTable"></div>
                    <div id="portfolioSummary" style="margin-top:20px;"></div>
                </div>
                <div class="controls-panel">
                    <h3 style="color:var(--accent-cyan); margin-bottom:15px;">‚ûï Add New Position</h3>
                    
                    <div class="control-group">
                        <label>Ticker</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="posTicker" class="value-input" placeholder="AAPL" style="flex:1; text-transform:uppercase;" onchange="window.loadOptionChainForAddPosition?.()">
                            <button id="posFetchPriceBtn" class="btn-secondary" style="padding:6px 10px;" onclick="window.loadOptionChainForAddPosition?.()" title="Load live option chain from Schwab or CBOE for this ticker">üìä Load Chain</button>
                        </div>
                        <div id="posPriceStatus" style="font-size:11px; color:#888; margin-top:4px;"></div>
                    </div>
                    
                    <div class="control-group">
                        <label>Type</label>
                        <select id="posType" style="width:100%; padding:8px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff;" onchange="togglePositionTypeFields(); window.loadOptionChainForAddPosition?.()">
                            <optgroup label="Single Leg">
                                <option value="short_put">Short Put (Cash Secured)</option>
                                <option value="short_call">Short Call (Covered)</option>
                                <option value="buy_write">Buy/Write (Stock + Call)</option>
                                <option value="long_put">Long Put</option>
                                <option value="long_call">Long Call</option>
                            </optgroup>
                            <optgroup label="Vertical Spreads">
                                <option value="call_debit_spread">Call Debit Spread (Bull Call)</option>
                                <option value="put_debit_spread">Put Debit Spread (Bear Put)</option>
                                <option value="call_credit_spread">Call Credit Spread (Bear Call)</option>
                                <option value="put_credit_spread">Put Credit Spread (Bull Put)</option>
                            </optgroup>
                            <optgroup label="LEAPS Strategies">
                                <option value="long_call_leaps">LEAPS Call (12+ months)</option>
                                <option value="skip_call">SKIP Call‚Ñ¢ (LEAPS + Shorter Call)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Spread extra fields (hidden by default) -->
                    <div id="spreadFields" class="control-group" style="display:none; background:rgba(122,138,148,0.1); padding:12px; border-radius:8px; border:1px solid rgba(122,138,148,0.3);">
                        <div style="color:#7a8a94; font-weight:bold; margin-bottom:10px;">üìä Spread Details</div>
                        <div class="control-row">
                            <div class="control-group" style="flex:1;">
                                <label>Buy Strike $</label>
                                <input type="number" id="posBuyStrike" class="value-input" min="1" max="5000" step="0.5" placeholder="170" style="width:100%;">
                            </div>
                            <div class="control-group" style="flex:1;">
                                <label>Sell Strike $</label>
                                <input type="number" id="posSellStrike" class="value-input" min="1" max="5000" step="0.5" placeholder="210" style="width:100%;">
                            </div>
                        </div>
                        <div style="font-size:11px; color:#888; margin-top:8px;" id="spreadExplanation">
                            üí° For Call Debit Spread: Buy lower strike, Sell higher strike
                        </div>
                    </div>
                    
                    <!-- Buy/Write extra fields (hidden by default) -->
                    <div id="buyWriteFields" class="control-group" style="display:none;">
                        <label>Stock Purchase Price $</label>
                        <input type="number" id="posStockPrice" class="value-input" min="0.01" max="10000" step="0.01" placeholder="e.g. 150.00" style="width:100%;">
                        <div style="font-size:10px; color:#888; margin-top:4px;">
                            Net cost basis = Stock - Premium received
                        </div>
                    </div>
                    
                    <!-- SKIP Strategy fields (hidden by default) -->
                    <div id="skipFields" class="control-group" style="display:none; background:rgba(255,215,0,0.1); padding:12px; border-radius:8px; border:1px solid rgba(255,215,0,0.3);">
                        <div style="color:#ffd700; font-weight:bold; margin-bottom:10px;">üéØ SKIP Call‚Ñ¢ Strategy</div>
                        <div style="font-size:11px; color:#aaa; margin-bottom:12px;">
                            Safely Keep Increasing Profits - Take profits on shorter calls while LEAPS rides the trend
                        </div>
                        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:6px; margin-bottom:12px;">
                            <div style="color:#ffd700; font-size:11px; margin-bottom:8px;">üìä LEAPS POSITION (Core - 12+ months)</div>
                            <div class="control-row">
                                <div class="control-group" style="flex:1;">
                                    <label>LEAPS Strike $</label>
                                    <input type="number" id="posLeapsStrike" class="value-input" min="1" max="5000" step="0.5" placeholder="100" style="width:100%;">
                                </div>
                                <div class="control-group" style="flex:1;">
                                    <label>LEAPS Premium $</label>
                                    <input type="number" id="posLeapsPremium" class="value-input" min="0" max="500" step="0.01" placeholder="15.00" style="width:100%;">
                                </div>
                            </div>
                            <div class="control-group">
                                <label>üìÖ LEAPS Expiry</label>
                                <input type="date" id="posLeapsExpiry" style="width:100%; padding:6px; background:rgba(255,215,0,0.15); border:1px solid rgba(255,215,0,0.3); border-radius:4px; color:#fff;">
                            </div>
                        </div>
                        <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:6px;">
                            <div style="color:#00d9ff; font-size:11px; margin-bottom:8px;">‚ö° SKIP CALL (Shorter - 3-9 months)</div>
                            <div style="font-size:10px; color:#888; margin-bottom:8px;">Exit SKIP 45-60 days before expiry to capture gains</div>
                            <!-- Strike/Premium use main fields, Expiry uses main posExpiry -->
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-group">
                            <label>Strike $</label>
                            <input type="number" id="posStrike" class="value-input" min="1" max="5000" step="0.5" style="width:100%; background:rgba(0,255,136,0.1);" readonly placeholder="‚Üê Select from chain">
                        </div>
                        <div class="control-group">
                            <label>Premium $</label>
                            <input type="number" id="posPremium" class="value-input" min="0" max="500" step="0.01" style="width:100%; background:rgba(0,255,136,0.1);" readonly placeholder="‚Üê Select from chain">
                        </div>
                    </div>
                    
                    <!-- Option Chain Picker - Shows automatically when ticker is entered -->
                    <div id="optionChainPicker" style="margin:15px 0; padding:15px; background:linear-gradient(135deg, rgba(0,217,255,0.1) 0%, rgba(0,153,204,0.05) 100%); border:1px solid rgba(0,217,255,0.4); border-radius:8px; display:none;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <span style="color:#00d9ff; font-weight:bold;">üìä Live Option Chain</span>
                            <span id="chainSpotPrice" style="font-size:12px; color:#888;"></span>
                        </div>
                        
                        <div style="display:flex; gap:12px; margin-bottom:12px;">
                            <div style="flex:2;">
                                <label style="color:#888; font-size:11px;">Select Expiry:</label>
                                <select id="posExpiry" onchange="window.loadStrikesForExpiry?.()" style="width:100%; padding:8px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; margin-top:4px;">
                                    <option value="">Loading expiries...</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label style="color:#888; font-size:11px;">Strikes:</label>
                                <select id="strikeCountSelect" onchange="window.loadOptionChainForAddPosition?.()" style="width:100%; padding:8px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff; margin-top:4px;">
                                    <option value="10">10 Strikes</option>
                                    <option value="20">20 Strikes</option>
                                    <option value="30" selected>30 Strikes</option>
                                    <option value="50">50 Strikes</option>
                                    <option value="100">All Strikes</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="strikePickerContainer" style="display:none;">
                            <label style="color:#888; font-size:11px;">Select Strike (click to select):</label>
                            <div id="strikePicker" style="max-height:250px; overflow-y:auto; margin-top:8px; border:1px solid rgba(0,217,255,0.2); border-radius:4px;">
                                <!-- Strikes will be populated here -->
                            </div>
                        </div>
                        
                        <div id="selectedStrikeDisplay" style="display:none; margin-top:12px; padding:10px; background:rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3); border-radius:4px;">
                            <!-- Shows selected strike details -->
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-group" style="flex:1;">
                            <label>Contracts</label>
                            <input type="number" id="posContracts" class="value-input" min="1" max="1000" step="1" value="1" style="width:100%;" oninput="window.updateAddPositionCredit?.()">
                        </div>
                        <div class="control-group" style="flex:0.5;">
                            <label>Œî Delta</label>
                            <input type="number" id="posDelta" class="value-input" min="0" max="1" step="0.01" placeholder="0.30" style="width:100%;" readonly>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-group" style="flex:1;">
                            <label>üóìÔ∏è Trade Opened</label>
                            <input type="date" id="posOpenDate" style="width:100%; padding:6px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff;">
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-group" style="flex:1;">
                            <label>üè¶ Broker</label>
                            <select id="posBroker" style="width:100%; padding:6px; background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.3); border-radius:4px; color:#fff;">
                                <option value="Schwab">Schwab</option>
                                <option value="Robinhood">Robinhood</option>
                                <option value="Fidelity">Fidelity</option>
                                <option value="TD">TD Ameritrade</option>
                                <option value="IBKR">IBKR</option>
                                <option value="Webull">Webull</option>
                                <option value="Tastytrade">Tastytrade</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Schwab Order Section -->
                    <div id="positionSchwabSection" style="margin-top:15px; padding:12px; background:rgba(0,255,136,0.08); border:1px solid rgba(0,255,136,0.3); border-radius:6px;">
                        <label style="display:flex; align-items:center; cursor:pointer; user-select:none;">
                            <input type="checkbox" id="posSendToSchwab" onchange="window.updateAddPositionSchwabPreview?.()" style="margin-right:8px; width:16px; height:16px; cursor:pointer;">
                            <span style="font-weight:bold; color:#00ff88;">üì§ Also send order to Schwab</span>
                        </label>
                        <div id="posAddSchwabPreview" style="display:none; margin-top:10px; padding:10px; background:rgba(0,0,0,0.3); border-radius:4px;">
                            <!-- Order preview will be populated here -->
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button id="addPositionBtn" class="btn-success" style="flex:1;" title="Save this position to your portfolio">‚ûï Add Position</button>
                        <button id="cancelEditBtn" class="btn-secondary" style="flex:0.4; display:none;" title="Cancel editing this position">‚úï Cancel</button>
                        <button onclick="window.clearAddPositionForm?.()" class="btn-secondary" style="flex:0.4;" title="Clear all fields in the form">‚úï Cancel</button>
                    </div>
                    
                    <div style="margin-top:15px; padding:10px; background:rgba(255,170,0,0.1); border-radius:6px; font-size:12px; color:var(--accent-orange);">
                        üí° Positions are saved in your browser's local storage.
                    </div>
                </div>
                
                <!-- Roll Position Panel -->
                <div id="rollPanel" class="results-box" style="display:none; margin-top:15px; background:rgba(156,39,176,0.15); border:1px solid rgba(156,39,176,0.4);">
                    <h3 style="color:#ce93d8; margin-bottom:12px;">üîÑ Roll Position</h3>
                    <div id="rollCurrentInfo" style="background:rgba(0,0,0,0.3); padding:8px; border-radius:4px; margin-bottom:12px; font-size:12px; color:#aaa;"></div>
                    
                    <div class="control-group">
                        <label style="color:#ce93d8;">Closing Price (buy back old)</label>
                        <input type="number" id="rollClosingPrice" class="value-input" min="0" max="500" step="0.01" value="0" style="width:100%;">
                    </div>
                    
                    <div style="border-top:1px solid rgba(156,39,176,0.3); margin:12px 0; padding-top:12px;">
                        <div style="color:#ce93d8; font-weight:600; margin-bottom:8px;">New Position:</div>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-group">
                            <label>New Strike $</label>
                            <input type="number" id="rollNewStrikeInput" class="value-input" min="1" max="5000" step="0.5" style="width:100%;">
                        </div>
                        <div class="control-group">
                            <label>New Premium $</label>
                            <input type="number" id="rollNewPremium" class="value-input" min="0" max="500" step="0.01" style="width:100%;">
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>üìÖ New Expiry</label>
                        <input type="date" id="rollNewExpiryInput" style="width:100%; padding:6px; background:rgba(156,39,176,0.15); border:1px solid rgba(156,39,176,0.3); border-radius:4px; color:#fff;">
                    </div>
                    
                    <div id="rollNetDisplay" style="margin-top:10px; padding:8px; background:rgba(0,0,0,0.3); border-radius:4px; font-size:13px; text-align:center; display:none;">
                        Net: <span id="rollNetValue">‚Äî</span>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button id="executeRollBtn" class="btn-success" style="flex:1; background:#9c27b0;" title="Close current position and open new rolled position">üîÑ Execute Roll</button>
                        <button id="cancelRollBtn" class="btn-secondary" style="flex:0.4;" title="Cancel this roll">‚úï Cancel</button>
                    </div>
                </div>
                
                <!-- Close Position Panel -->
                <div id="closePanel" class="results-box" style="display:none; margin-top:15px; background:rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.4);">
                    <h3 style="color:var(--accent-green); margin-bottom:12px;">‚úÖ Close Position</h3>
                    <div id="closeCurrentInfo" style="background:rgba(0,0,0,0.3); padding:8px; border-radius:4px; margin-bottom:12px; font-size:12px; color:#aaa;"></div>
                    
                    <div class="control-group">
                        <label style="color:var(--accent-green);">Closing Price (what you paid to buy back)</label>
                        <input type="number" id="closeClosingPrice" class="value-input" min="0" max="500" step="0.01" value="0" style="width:100%;">
                        <div style="font-size:10px; color:#888; margin-top:4px;">Enter 0 if expired worthless</div>
                    </div>
                    
                    <div class="control-group">
                        <label>üìÖ Close Date</label>
                        <input type="date" id="closeDate" style="width:100%; padding:6px; background:rgba(0,255,136,0.15); border:1px solid rgba(0,255,136,0.3); border-radius:4px; color:#fff;">
                    </div>
                    
                    <div id="closePnLPreview" style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.3); border-radius:4px; font-size:14px; text-align:center;">
                        P&L: <span id="closePnLValue" style="font-weight:bold;">‚Äî</span>
                    </div>
                    
                    <!-- Send to Schwab Section -->
                    <div style="margin-top:12px; padding:12px; background:rgba(0,217,255,0.08); border:1px solid rgba(0,217,255,0.3); border-radius:8px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#00d9ff;">
                            <input type="checkbox" id="closeSendToSchwab" onchange="window.updateClosePreview()" style="width:18px; height:18px; accent-color:#00d9ff;">
                            <span style="font-weight:500;">üì§ Also send order to Schwab</span>
                        </label>
                        
                        <div id="closeSchwabPreview" style="display:none; margin-top:10px;">
                            <div style="font-size:11px; color:#888; margin-bottom:6px;">Loading order preview...</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button id="executeCloseBtn" class="btn-success" style="flex:1;" title="Close this position and record P&L">‚úÖ Confirm Close</button>
                        <button id="cancelCloseBtn" class="btn-secondary" style="flex:0.4;" title="Cancel closing this position">‚úï Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PORTFOLIO TAB -->
        <div class="tab-content" id="portfolio">
            <div class="main-grid">
                <div class="canvas-section" style="overflow-y: auto;">
                    <!-- Account Balances Banner -->
                    <div id="accountBalancesBanner" style="display:none; background:linear-gradient(135deg, rgba(0,217,255,0.12), rgba(0,255,136,0.08)); border:1px solid rgba(0,217,255,0.3); border-radius:10px; padding:12px 16px; margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; gap:30px; flex-wrap:wrap;">
                                <div style="text-align:center;">
                                    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Cash Available</div>
                                    <div id="balCashAvailable" style="font-size:20px; font-weight:600; color:#00ff88;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Buying Power</div>
                                    <div id="balBuyingPower" style="font-size:20px; font-weight:600; color:#00d9ff;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Account Value</div>
                                    <div id="balAccountValue" style="font-size:20px; font-weight:600; color:#fff;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Margin Used</div>
                                    <div id="balMarginUsed" style="font-size:20px; font-weight:600; color:#ffaa00;">‚Äî</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Day Trade BP</div>
                                    <div id="balDayTradeBP" style="font-size:20px; font-weight:600; color:#888;">‚Äî</div>
                                </div>
                                <div style="text-align:center; border-left:1px solid rgba(255,255,255,0.1); padding-left:20px; margin-left:10px;">
                                    <div style="font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px;">Capital at Risk</div>
                                    <div id="balCapitalAtRisk" style="font-size:20px; font-weight:600; color:#ff5252;">‚Äî</div>
                                </div>
                            </div>
                            <button id="refreshBalancesBtn" style="background:linear-gradient(135deg, rgba(0,217,255,0.2), rgba(0,217,255,0.1)); border:1px solid rgba(0,217,255,0.4); color:#00d9ff; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:11px; font-weight:500; transition:all 0.2s;" onmouseover="this.style.background='linear-gradient(135deg, rgba(0,217,255,0.3), rgba(0,217,255,0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(0,217,255,0.2), rgba(0,217,255,0.1))'" title="Refresh balances from Schwab">üîÑ Refresh Balances</button>
                        </div>
                        <div id="balanceLastUpdated" style="font-size:10px; color:#666; margin-top:6px; text-align:right;">‚Äî</div>
                    </div>
                    
                    <!-- Dashboard Row: Win Rate, P&L Chart, Expiration Calendar -->
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:15px;">
                        <!-- Win Rate Dashboard -->
                        <div class="results-box" style="background:rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3); margin:0; padding:12px;">
                            <h3 style="color:#00ff88; font-size:13px; margin-bottom:8px;">üèÜ Win Rate <span id="winRateYearLabel" style="font-size:10px; color:#888;">(2026)</span></h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px; font-size:11px;">
                                <div class="result-row"><span class="result-label">Win Rate:</span><span class="result-value" id="dashWinRate" style="color:#00ff88;">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">Trades:</span><span class="result-value" id="dashTotalTrades">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">Avg DTE:</span><span class="result-value" id="dashAvgDTE">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">Avg Prem:</span><span class="result-value" id="dashAvgPremium">‚Äî</span></div>
                            </div>
                            <div style="border-top:1px solid rgba(255,255,255,0.1); margin:6px 0; padding-top:6px; font-size:10px;">
                                <div class="result-row"><span class="result-label">üèÖ Best:</span><span class="result-value" id="dashBestTicker" style="color:#00ff88;">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">‚ö†Ô∏è Worst:</span><span class="result-value" id="dashWorstTicker" style="color:#ff5252;">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">üöÄ Big Win:</span><span class="result-value" id="dashBiggestWin" style="color:#00ff88;">‚Äî</span></div>
                                <div class="result-row"><span class="result-label">üíÄ Big Loss:</span><span class="result-value" id="dashBiggestLoss" style="color:#ff5252;">‚Äî</span></div>
                            </div>
                        </div>
                        
                        <!-- P&L Chart -->
                        <div class="results-box" style="background:rgba(122,138,148,0.1); border:1px solid rgba(122,138,148,0.3); margin:0; padding:12px;">
                            <h3 style="color:#7a8a94; font-size:13px; margin-bottom:8px;">üìà Cumulative P&L <span id="pnlChartYearLabel" style="font-size:10px; color:#888;">(2026)</span></h3>
                            <canvas id="pnlChartCanvas" width="300" height="140" style="width:100%; background:#0a0a15; border-radius:4px;"></canvas>
                            <div style="display:flex; justify-content:space-between; font-size:9px; color:#888; margin-top:4px;">
                                <span id="pnlChartStart">‚Äî</span>
                                <span id="pnlChartEnd">‚Äî</span>
                            </div>
                        </div>
                        
                        <!-- Expiration Calendar -->
                        <div class="results-box" style="background:rgba(255,170,0,0.1); border:1px solid rgba(255,170,0,0.3); margin:0; padding:12px;">
                            <h3 style="color:#ffaa00; font-size:13px; margin-bottom:6px;">üìÖ Expirations</h3>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                                <button onclick="window.changeCalendarMonth(-1)" style="background:none; border:none; color:#ffaa00; cursor:pointer; font-size:12px;" title="Previous month">‚óÄ</button>
                                <span id="calendarMonthLabel" style="font-weight:600; color:#ddd; font-size:11px;">January 2026</span>
                                <button onclick="window.changeCalendarMonth(1)" style="background:none; border:none; color:#ffaa00; cursor:pointer; font-size:12px;" title="Next month">‚ñ∂</button>
                            </div>
                            <div id="expirationCalendar" style="font-size:10px;"></div>
                            <div id="calendarLegend" style="font-size:8px; color:#888; margin-top:4px; display:flex; gap:8px; justify-content:center;">
                                <span>üü¢ Put</span>
                                <span>üîµ Call</span>
                                <span>üü£ Spread</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:var(--accent-cyan); margin:0;">üíº Holdings & Trade History</h3>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <button id="weekSummaryBtn" onclick="window.showWeekSummary()" class="btn-primary" style="padding:6px 12px; background:linear-gradient(135deg, rgba(0,217,255,0.25), rgba(0,217,255,0.15)); border-color:rgba(0,217,255,0.5); color:#00d9ff;" title="Generate AI weekly performance summary">üìä Week Summary</button>
                            <button id="coachBtn" onclick="window.showCoachPanel()" class="btn-primary" style="padding:6px 12px; background:linear-gradient(135deg, rgba(255,170,0,0.25), rgba(255,170,0,0.15)); border-color:rgba(255,170,0,0.5); color:#ffaa00;" title="View your trading patterns, win rates, and coaching insights">üéØ Trading Coach</button>
                            <button id="refreshPortfolioBtn" class="btn-primary" style="padding:6px 12px;" title="Fetch latest spot prices for all tickers in your portfolio">üîÑ Refresh Prices</button>
                        </div>
                    </div>
                    
                    <div id="portfolioLoading" style="display:none; text-align:center; padding:20px; color:var(--accent-orange);">
                        <div class="spinner" style="display:inline-block; margin-right:10px;"></div>
                        Fetching live prices...
                    </div>
                    
                    <!-- Holdings Section (Collapsible) - Stocks you own -->
                    <div id="holdingsSection" style="margin-top:10px; display:none;">
                        <div class="collapsible-header" onclick="toggleSection('holdings')" id="holdingsHeader" style="background:rgba(255,140,0,0.1); border:1px solid rgba(255,140,0,0.2);">
                            <h4 style="color:#fa0;">
                                <span class="collapsible-arrow">‚ñº</span>
                                üì¶ Share Holdings
                            </h4>
                            <div class="collapsible-summary" id="holdingsSummary"></div>
                        </div>
                        <div class="collapsible-content" id="holdingsContent" style="padding:15px; background:rgba(255,140,0,0.05); border-radius:0 0 8px 8px; border:1px solid rgba(255,140,0,0.2); border-top:none;">
                            <div style="font-size:11px; color:#888; margin-bottom:10px;">Shares from Buy/Writes and Put Assignments</div>
                            <div id="holdingsTable" style="color:#888; font-size:13px;">No shares from assignments.</div>
                        </div>
                    </div>
                    
                    <!-- Closed Positions Section (Collapsible) -->
                    <div style="margin-top:20px;">
                        <div class="collapsible-header" onclick="toggleSection('closedPositions')" id="closedPositionsHeader" style="background:rgba(0,0,0,0.3);">
                            <h4 style="color:var(--accent-orange);">
                                <span class="collapsible-arrow">‚ñº</span>
                                üìú Closed Positions
                            </h4>
                            <div class="collapsible-summary" id="closedPositionsSummary"></div>
                        </div>
                        <div class="collapsible-content" id="closedPositionsContent" style="padding:15px; background:rgba(0,0,0,0.3); border-radius:0 0 8px 8px;">
                            <div id="closedPositionsTable" style="color:#888; font-size:13px;">No closed positions yet.</div>
                        </div>
                    </div>
                </div>
                
                <div class="controls-panel">
                    <div class="results-box" style="background:rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3);">
                        <h3 style="color:var(--accent-green);">üìä Portfolio Summary</h3>
                        <div class="result-row"><span class="result-label">Open Positions:</span><span class="result-value" id="portOpenCount">0</span></div>
                        <div class="result-row"><span class="result-label">Net Premium:</span><span class="result-value call" id="portTotalPremium" title=\"Collected minus paid (includes roll buybacks)\">$0</span></div>
                        <div class="result-row"><span class="result-label">Capital at Risk:</span><span class="result-value" id="portCapitalRisk" title="Max loss if all positions go against you">$0</span></div>
                        <div style="border-top:1px solid rgba(255,255,255,0.2); margin:10px 0; padding-top:10px;">
                            <div class="result-row"><span class="result-label">Unrealized P&L:</span><span class="result-value" id="portUnrealizedPnL">$0</span></div>
                            <div class="result-row"><span class="result-label">Realized P&L:</span><span class="result-value" id="portRealizedPnL">$0</span></div>
                            <div class="result-row" style="font-size:16px; font-weight:bold;"><span class="result-label">Total P&L:</span><span class="result-value" id="portTotalPnL">$0</span></div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Greeks Dashboard -->
                    <div class="results-box" style="margin-top:15px; background:rgba(122,138,148,0.1); border:1px solid rgba(122,138,148,0.3);">
                        <h3 style="color:#7a8a94;">üìê Portfolio Greeks & IV</h3>
                        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;">
                            <div style="text-align:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <div style="font-size:24px; font-weight:bold;" id="portDelta">‚Äî</div>
                                <div style="font-size:11px; color:#888;">Œî Delta</div>
                                <div style="font-size:9px; color:#666;">Shares equivalent</div>
                            </div>
                            <div style="text-align:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <div style="font-size:24px; font-weight:bold; color:#00ff88;" id="portTheta">‚Äî</div>
                                <div style="font-size:11px; color:#888;">Œò Theta</div>
                                <div style="font-size:9px; color:#666;">$/day time decay</div>
                            </div>
                            <div style="text-align:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <div style="font-size:24px; font-weight:bold;" id="portGamma">‚Äî</div>
                                <div style="font-size:11px; color:#888;">Œì Gamma</div>
                                <div style="font-size:9px; color:#666;">Delta change rate</div>
                            </div>
                            <div style="text-align:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <div style="font-size:24px; font-weight:bold;" id="portVega">‚Äî</div>
                                <div style="font-size:11px; color:#888;">ŒΩ Vega</div>
                                <div style="font-size:9px; color:#666;">$/1% IV move</div>
                            </div>
                            <div style="text-align:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <div style="font-size:24px; font-weight:bold;" id="portAvgIV">‚Äî</div>
                                <div style="font-size:11px; color:#888;">Avg IV</div>
                                <div style="font-size:9px; color:#666;">Implied volatility</div>
                            </div>
                            <div style="text-align:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                                <div style="font-size:24px; font-weight:bold;" id="portIVRank">‚Äî</div>
                                <div style="font-size:11px; color:#888;">IV Rank</div>
                                <div style="font-size:9px; color:#666;">vs 52wk range</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button id="refreshPricesBtn" class="btn-primary" style="flex:1; padding:8px; background:rgba(0,217,255,0.2); border:1px solid rgba(0,217,255,0.4);" title="Fetch real-time option prices from Schwab (or CBOE if not connected)">üí≤ Refresh Prices</button>
                            <button id="refreshGreeksBtn" class="btn-primary" style="flex:1; padding:8px;" title="Calculate Greeks (Delta, Theta, Gamma, Vega) for all open positions">üîÑ Greeks & IV</button>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:8px; padding:6px 10px; background:rgba(0,0,0,0.2); border-radius:6px;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px; color:#aaa;">
                                <input type="checkbox" id="autoRefreshPricesCheckbox" style="cursor:pointer;">
                                <span>Auto-refresh (30s)</span>
                            </label>
                            <span id="priceLastUpdated" style="font-size:11px; color:#666; margin-left:auto;"></span>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <button id="aiPortfolioAuditBtn" onclick="window.runPortfolioAudit()" class="btn-primary" style="flex:1; padding:8px; background:rgba(122,138,148,0.3); border:1px solid rgba(122,138,148,0.6);" title="AI analyzes your entire portfolio for concentration risk, problem positions, and optimization opportunities">ü§ñ AI Audit</button>
                            <button id="aiPerformanceBtn" onclick="window.showAIPerformanceReview()" class="btn-primary" style="flex:1; padding:8px; background:rgba(0,217,255,0.2); border:1px solid rgba(0,217,255,0.5);" title="Review how accurate AI predictions have been on your closed trades">üìä AI Accuracy</button>
                        </div>
                    </div>
                    
                    <!-- Advanced Analytics -->
                    <div class="results-box" style="margin-top:15px; background:rgba(255,170,0,0.1); border:1px solid rgba(255,170,0,0.3);">
                        <h3 style="color:#ffaa00;">üìä Advanced Analytics <span id="analyticsYearLabel" style="font-size:12px; color:#888;">(2026)</span></h3>
                        <div class="result-row"><span class="result-label">Profit Factor:</span><span class="result-value" id="portProfitFactor">‚Äî</span></div>
                        <div class="result-row"><span class="result-label">Avg Win:</span><span class="result-value" id="portAvgWin" style="color:#00ff88;">‚Äî</span></div>
                        <div class="result-row"><span class="result-label">Avg Loss:</span><span class="result-value" id="portAvgLoss" style="color:#ff5252;">‚Äî</span></div>
                        <div class="result-row"><span class="result-label">Expectancy:</span><span class="result-value" id="portExpectancy">‚Äî</span></div>
                        <div class="result-row"><span class="result-label">Max Drawdown:</span><span class="result-value" id="portMaxDrawdown" style="color:#ff5252;">‚Äî</span></div>
                        <div style="border-top:1px solid rgba(255,255,255,0.1); margin:10px 0; padding-top:10px;">
                            <div class="result-row"><span class="result-label">Kelly % (Suggested):</span><span class="result-value" id="portKelly" style="color:#00d9ff;">‚Äî</span></div>
                            <div class="result-row"><span class="result-label">Half Kelly Size:</span><span class="result-value" id="portHalfKelly">‚Äî</span></div>
                        </div>
                    </div>
                    
                    <div style="margin-top:15px; padding:12px; background:rgba(0,217,255,0.1); border-radius:6px; font-size:12px;">
                        <div style="color:var(--accent-cyan); font-weight:600; margin-bottom:5px;">üí° How to Use</div>
                        <div style="color:#aaa;">
                            <b>Holdings:</b> Stocks you own (from assignments or buy-writes)<br>
                            <b>Closed Trades:</b> Completed option trades with realized P&L<br><br>
                            <b>Tip:</b> Manage open options in the <span style="color:#00d9ff;">Positions</span> tab<br>
                            <i style="color:var(--accent-green);">Summary shows combined open + closed P&L</i>
                        </div>
                    </div>
                    
                    <!-- CHALLENGES SECTION (Integrated from Challenges tab) -->
                    <div style="margin-top:20px; border-top:2px solid rgba(255,170,0,0.3); padding-top:15px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; cursor:pointer;" onclick="toggleChallengesSection()">
                            <h3 style="color:#ffaa00; margin:0;">üèÜ Trading Challenges</h3>
                            <span id="challengesToggle" style="color:#888; font-size:18px;">‚ñº</span>
                        </div>
                        <div id="challengesSectionContent">
                            <!-- Challenges rendered by challenges.js into this container -->
                            <div id="portfolioChallengesContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GREEKS TAB -->
        <div class="tab-content" id="greeks">
            <div class="main-grid">
                <div class="canvas-section">
                    <h3 style="color:var(--accent-cyan); margin-bottom:10px;">üìê Greeks Visualization</h3>
                    <canvas id="greeksCanvas" width="800" height="200"></canvas>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background:var(--accent-green)"></div>Call</div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--accent-red)"></div>Put</div>
                    </div>
                </div>
                <div class="controls-panel">
                    <div class="control-group">
                        <label>Bump Size (for numerical differentiation)</label>
                        <input type="range" id="bumpSlider" min="0.005" max="0.05" step="0.005" value="0.01">
                    </div>
                    
                    <button id="greeksBtn" class="btn-primary" style="width:100%;" title="Calculate Delta, Gamma, and Vega for call and put options using numerical differentiation">üßÆ Calculate Greeks</button>
                    
                    <div class="running" id="greekRunning"><div class="spinner"></div>Computing...</div>
                    
                    <div class="results-box greeks" style="margin-top:15px;">
                        <h3>üìê Call Greeks</h3>
                        <div class="greeks-grid">
                            <div class="greek-card"><div class="greek-symbol">Œî</div><div class="greek-value" id="callDelta">‚Äî</div><div class="greek-name">Delta</div></div>
                            <div class="greek-card"><div class="greek-symbol">Œì</div><div class="greek-value" id="callGamma">‚Äî</div><div class="greek-name">Gamma</div></div>
                            <div class="greek-card"><div class="greek-symbol">ŒΩ</div><div class="greek-value" id="callVega">‚Äî</div><div class="greek-name">Vega</div></div>
                        </div>
                    </div>
                    
                    <div class="results-box greeks" style="margin-top:15px;">
                        <h3>üìê Put Greeks</h3>
                        <div class="greeks-grid">
                            <div class="greek-card"><div class="greek-symbol">Œî</div><div class="greek-value" id="putDelta">‚Äî</div><div class="greek-name">Delta</div></div>
                            <div class="greek-card"><div class="greek-symbol">Œì</div><div class="greek-value" id="putGamma">‚Äî</div><div class="greek-name">Gamma</div></div>
                            <div class="greek-card"><div class="greek-symbol">ŒΩ</div><div class="greek-value" id="putVega">‚Äî</div><div class="greek-name">Vega</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHALLENGES TAB -->
        <div class="tab-content" id="challenges">
            <!-- Content rendered by challenges.js -->
        </div>

        <!-- DATA TAB -->
        <div class="tab-content" id="data">
            <div class="main-grid">
                <div class="canvas-section">
                    <h3 style="color:var(--accent-cyan); margin-bottom:10px;">üìä Simulation Data</h3>
                    <div id="dataContent"></div>
                </div>
                <div class="controls-panel">
                    <h3 style="color:var(--accent-cyan); margin-bottom:15px;">üíæ Export Options</h3>
                    <button class="btn-success" style="width:100%; margin-bottom:10px;" onclick="window.exportJSON()" title="Export all simulation data as JSON file">üì• Export JSON</button>
                    <button class="btn-secondary" style="width:100%; margin-bottom:10px;" onclick="window.exportCSV()" title="Export simulation data as CSV spreadsheet">üì• Export CSV</button>
                    <button class="btn-secondary" style="width:100%; margin-bottom:20px;" onclick="window.copyData()" title="Copy simulation data to clipboard for pasting into spreadsheets">üìã Copy to Clipboard</button>
                    
                    <!-- AI Trade Ideas Section -->
                    <div style="border-top:1px solid #333; padding-top:15px; margin-top:10px;">
                        <h3 style="color:#7a8a94; margin-bottom:15px;">ü§ñ AI Trade Ideas</h3>
                        
                        <div class="input-group" style="margin-bottom:10px;">
                            <label style="font-size:11px; color:#888;">Buying Power ($)</label>
                            <input type="number" id="ideaBuyingPower" value="25000" min="1000" step="1000" 
                                   style="width:100%; padding:8px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:4px;">
                        </div>
                        
                        <div class="input-group" style="margin-bottom:10px;">
                            <label style="font-size:11px; color:#888;">Target Annual ROC (%)</label>
                            <input type="number" id="ideaTargetROC" value="25" min="5" max="100" step="5"
                                   style="width:100%; padding:8px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:4px;">
                        </div>
                        
                        <div class="input-group" style="margin-bottom:10px;">
                            <label style="font-size:11px; color:#888;">Sectors to Avoid (optional)</label>
                            <input type="text" id="ideaSectorsAvoid" placeholder="e.g., Tech, Energy"
                                   style="width:100%; padding:8px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:4px;">
                        </div>
                        
                        <div class="input-group" style="margin-bottom:15px;">
                            <label style="font-size:11px; color:#888;">Model <span style="color:#666; font-size:10px;">(32B best for ideas)</span></label>
                            <select id="ideaModelSelect" style="width:100%; padding:8px; background:#1a1a2e; border:1px solid #333; color:#ddd; border-radius:4px;">
                                <option value="qwen2.5:7b">Qwen 7B (Fast)</option>
                                <option value="qwen2.5:14b">Qwen 14B (Better)</option>
                                <option value="qwen2.5:32b">Qwen 32B</option>
                                <option value="deepseek-r1:32b" selected>DeepSeek-R1 (Best) üßÆ</option>
                                <option value="grok-3">üöÄ Grok-3 (Cloud - Fastest)</option>
                                <option value="grok-4">üß† Grok-4 (Reasoning)</option>
                                <option value="grok-4-1-fast">‚ö° Grok 4.1 Fast (Best)</option>
                                <option value="grok-3-mini">üöÄ Grok-3 Mini (Cloud)</option>
                            </select>
                        </div>
                        
                        <button id="ideaBtn" class="btn-success" style="width:100%; background:linear-gradient(135deg, #7a8a94 0%, #6a7a88 100%);" 
                                onclick="window.getTradeIdeas()" title="AI generates trade ideas based on your buying power and constraints">
                            üí° Generate Ideas
                        </button>
                        
                        <!-- X/Twitter Sentiment (Grok only) -->
                        <button id="xSentimentBtn" class="btn-success" style="width:100%; margin-top:8px; background:linear-gradient(135deg, #1da1f2 0%, #0d8ecf 100%); display:none;" 
                                onclick="window.getXSentiment()" title="Grok searches X/Twitter for trending tickers with strong sentiment">
                            üî• Trending on X (Grok)
                        </button>
                        
                        <!-- X Integration checkbox - shows after X Sentiment scan -->
                        <div id="xTickersOption" style="display:none; margin-top:8px; padding:8px; background:rgba(29,161,242,0.1); border-radius:6px; border:1px solid rgba(29,161,242,0.3);">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:11px; color:#1da1f2;">
                                <input type="checkbox" id="useXTickers" checked style="width:14px; height:14px; accent-color:#1da1f2;">
                                <span>Include <strong id="xTickerCount">0</strong> X trending</span>
                            </label>
                        </div>
                        
                        <div id="ideaResults" style="margin-top:15px; display:none; background:#0d0d1a; border-radius:8px; padding:12px; max-height:400px; overflow-y:auto;">
                            <div id="ideaContent" style="color:#ddd; font-size:12px; line-height:1.6; white-space:pre-wrap;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AUTONOMOUS TRADER TAB -->
        <div class="tab-content" id="autonomous">
            <!-- Top Controls Bar -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <h2 style="color:var(--accent-cyan); margin:0;">ü§ñ Autonomous Trader</h2>
                    <span id="autoTraderStatusBadge" style="font-size:12px; padding:4px 10px; border-radius:12px; background:rgba(255,82,82,0.2); color:#ff5252; border:1px solid rgba(255,82,82,0.4);">‚óè DISABLED</span>
                    <span id="autoTraderPhaseBadge" style="font-size:11px; color:#888;">Phase: Idle</span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="autoTraderToggleBtn" onclick="window.toggleAutonomousTrader()" class="btn-action" style="background:rgba(0,255,136,0.15); border:1px solid rgba(0,255,136,0.4); color:#00ff88; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px;">‚ñ∂ Enable Trader</button>
                    <button id="autoTraderRunPhaseBtn" onclick="window.showRunPhaseMenu()" class="btn-action" style="background:rgba(0,217,255,0.15); border:1px solid rgba(0,217,255,0.4); color:#00d9ff; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px;">‚ö° Run Phase</button>
                    <button onclick="window.showAutoTraderConfig()" class="btn-action" style="background:rgba(100,100,100,0.2); border:1px solid rgba(100,100,100,0.4); color:#aaa; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px;">‚öôÔ∏è Config</button>
                    <button id="autoTraderKillSwitch" onclick="window.killSwitchAutonomous()" class="btn-action" style="background:rgba(255,0,0,0.15); border:1px solid rgba(255,0,0,0.4); color:#ff5252; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:13px;">üõë Kill Switch</button>
                </div>
            </div>

            <!-- Performance Dashboard Row -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin-bottom:20px;" id="autoPerfCards">
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Paper Balance</div>
                    <div class="auto-perf-value" id="autoPaperBalance">$100,000</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Total P&L</div>
                    <div class="auto-perf-value" id="autoTotalPnl">$0.00</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Win Rate</div>
                    <div class="auto-perf-value" id="autoWinRate">‚Äî</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Total Trades</div>
                    <div class="auto-perf-value" id="autoTotalTrades">0</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Open Positions</div>
                    <div class="auto-perf-value" id="autoOpenCount">0 / 5</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Avg P&L / Trade</div>
                    <div class="auto-perf-value" id="autoAvgPnl">‚Äî</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Best Trade</div>
                    <div class="auto-perf-value" id="autoBestTrade">‚Äî</div>
                </div>
                <div class="auto-perf-card">
                    <div class="auto-perf-label">Worst Trade</div>
                    <div class="auto-perf-value" id="autoWorstTrade">‚Äî</div>
                </div>
                <div class="auto-perf-card" id="autoMarginCard" style="border-color:rgba(0,217,255,0.3);">
                    <div class="auto-perf-label">üõ°Ô∏è Margin Used</div>
                    <div class="auto-perf-value" id="autoMarginPct">0%</div>
                    <div style="margin-top:4px; height:4px; background:#222; border-radius:2px; overflow:hidden;">
                        <div id="autoMarginBar" style="height:100%; width:0%; background:#00ff88; border-radius:2px; transition:width 0.5s, background 0.5s;"></div>
                    </div>
                    <div style="font-size:9px; color:#555; margin-top:3px;" id="autoMarginDetail">$0 / $70,000</div>
                </div>
            </div>

            <!-- Two-Column Layout: Positions + Activity -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <!-- Open Positions Panel -->
                <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="color:#00ff88; margin:0; font-size:15px;">üìä Open Positions</h3>
                        <span id="autoOpenPnlTotal" style="font-size:13px; color:#888;">Unrealized: $0</span>
                    </div>
                    <div id="autoPositionsContainer" style="max-height:350px; overflow-y:auto;">
                        <div style="color:#555; text-align:center; padding:40px 0; font-size:13px;">
                            No open positions. Enable trader to begin.
                        </div>
                    </div>
                </div>

                <!-- Activity Log Panel -->
                <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="color:#00d9ff; margin:0; font-size:15px;">üìù Activity Log</h3>
                        <button onclick="window.clearAutoLog()" style="background:none; border:1px solid #444; color:#888; padding:3px 8px; border-radius:4px; cursor:pointer; font-size:11px;">Clear</button>
                    </div>
                    <div id="autoActivityLog" style="max-height:350px; overflow-y:auto; font-family:monospace; font-size:12px;">
                        <div style="color:#555; text-align:center; padding:40px 0;">
                            Activity will appear here when trader is running.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equity Curve Chart -->
            <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3 style="color:#ffaa00; margin:0; font-size:15px;">üìà Equity Curve</h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="window.refreshEquityCurve()" style="background:none; border:1px solid #444; color:#888; padding:3px 8px; border-radius:4px; cursor:pointer; font-size:11px;">üîÑ Refresh</button>
                    </div>
                </div>
                <canvas id="autoEquityCanvas" width="900" height="250" style="width:100%; max-height:250px; border-radius:8px;"></canvas>
            </div>

            <!-- Three-Column Bottom: Journal + Rules + Market Scans -->
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:20px;">
                <!-- Trade Journal -->
                <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="color:#bb86fc; margin:0; font-size:15px;">üìñ Trade Journal</h3>
                        <select id="autoJournalFilter" onchange="window.filterAutoJournal(this.value)" style="background:#0d0d1a; color:#aaa; border:1px solid #444; padding:3px 6px; border-radius:4px; font-size:11px;">
                            <option value="all">All</option>
                            <option value="win">Wins</option>
                            <option value="loss">Losses</option>
                        </select>
                    </div>
                    <div id="autoJournalContainer" style="max-height:300px; overflow-y:auto;">
                        <div style="color:#555; text-align:center; padding:30px 0; font-size:12px;">No closed trades yet.</div>
                    </div>
                </div>

                <!-- Learned Rules -->
                <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="color:#ff9800; margin:0; font-size:15px;">üß† Learned Rules</h3>
                        <span id="autoRulesCount" style="color:#888; font-size:11px;">0 rules</span>
                    </div>
                    <div id="autoRulesContainer" style="max-height:300px; overflow-y:auto;">
                        <div style="color:#555; text-align:center; padding:30px 0; font-size:12px;">AI will learn rules from trades.</div>
                    </div>
                </div>

                <!-- Market Scans -->
                <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="color:#4fc3f7; margin:0; font-size:15px;">üåê Market Scans</h3>
                        <span id="autoLastScan" style="color:#888; font-size:11px;">Last: Never</span>
                    </div>
                    <div id="autoScansContainer" style="max-height:300px; overflow-y:auto;">
                        <div style="color:#555; text-align:center; padding:30px 0; font-size:12px;">Grok scans market daily at 6 AM.</div>
                    </div>
                </div>
            </div>

            <!-- Daily Summaries (Collapsible) -->
            <div style="background:#1a1a2e; border-radius:12px; padding:16px; border:1px solid #333; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="document.getElementById('autoDailySummaries').style.display = document.getElementById('autoDailySummaries').style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = document.getElementById('autoDailySummaries').style.display === 'none' ? '‚ñ∂' : '‚ñº';">
                    <h3 style="color:#ce93d8; margin:0; font-size:15px;">üìÖ Daily Summaries</h3>
                    <span class="toggle-icon" style="color:#888;">‚ñ∂</span>
                </div>
                <div id="autoDailySummaries" style="display:none; margin-top:12px; max-height:400px; overflow-y:auto;">
                    <div style="color:#555; text-align:center; padding:30px 0; font-size:12px;">Daily reflections will appear after trading days.</div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" id="settings">
            <div style="max-width:800px; margin:0 auto;">
                <h2 style="color:var(--accent-cyan); margin-bottom:20px;">‚öôÔ∏è Settings</h2>
                <p style="color:#888; margin-bottom:25px; font-size:13px;">
                    Configure API keys for trading and AI analysis. Keys are stored securely on the server in .env file.
                </p>
                
                <!-- Security Status Banner -->
                <div id="securityBanner" style="background:#1a1a2e; border-radius:8px; padding:12px 16px; margin-bottom:20px; border:1px solid #333; display:flex; align-items:center; gap:12px;">
                    <span id="securityIcon" style="font-size:20px;">‚è≥</span>
                    <div>
                        <span id="securityStatus" style="color:#888; font-size:12px;">Checking security status...</span>
                    </div>
                </div>
                
                <!-- Schwab API Section -->
                <div style="background:#1a1a2e; border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#00ff88; margin:0;">
                            <span style="font-size:20px; margin-right:8px;">üìà</span> Schwab Trading API
                        </h3>
                        <span id="schwabStatus" style="padding:4px 12px; border-radius:12px; font-size:11px; background:#333; color:#888;">
                            Not Configured
                        </span>
                    </div>
                    <p style="color:#aaa; font-size:12px; margin-bottom:15px;">
                        Enable live trading and real-time account data. Get your API key from 
                        <a href="https://developer.schwab.com" target="_blank" style="color:#00d9ff;">developer.schwab.com</a>
                    </p>
                    
                    <div class="control-group" style="margin-bottom:12px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">App Key (Client ID)</label>
                        <input type="password" id="settingSchwabAppKey" placeholder="Enter Schwab App Key" 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                    </div>
                    
                    <div class="control-group" style="margin-bottom:12px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">App Secret</label>
                        <input type="password" id="settingSchwabAppSecret" placeholder="Enter Schwab App Secret" 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                    </div>
                    
                    <div class="control-group" style="margin-bottom:15px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Refresh Token</label>
                        <input type="password" id="settingSchwabRefreshToken" placeholder="Generated after OAuth login" 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                        <div style="font-size:10px; color:#666; margin-top:4px;">
                            After saving App Key/Secret, click "Authenticate with Schwab" to generate this token.
                        </div>
                    </div>
                    
                    <div class="control-group" style="margin-bottom:15px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Account to Sync</label>
                        <select id="schwabAccountSelect" 
                                style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                            <option value="">-- Click "Load Accounts" after authenticating --</option>
                        </select>
                        <button onclick="loadSchwabAccounts()" 
                                style="margin-top:8px; padding:6px 12px; background:rgba(122,138,148,0.2); border:1px solid rgba(122,138,148,0.4); color:#a78bfa; border-radius:6px; cursor:pointer; font-size:11px;" title="Fetch list of your Schwab accounts after authenticating">
                            üìã Load Accounts
                        </button>
                    </div>
                    
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="testSchwabConnection()" 
                                style="padding:8px 16px; background:rgba(0,255,136,0.2); border:1px solid rgba(0,255,136,0.4); color:#0f8; border-radius:6px; cursor:pointer;" title="Verify Schwab API credentials and connection">
                            üîå Test Connection
                        </button>
                        <button onclick="startSchwabOAuth()" 
                                style="padding:8px 16px; background:rgba(0,217,255,0.2); border:1px solid rgba(0,217,255,0.4); color:#0df; border-radius:6px; cursor:pointer;" title="Opens Schwab login page to authorize WheelHouse access">
                            üîê Authenticate with Schwab
                        </button>
                        <button onclick="syncAccountFromSchwab()" 
                                id="schwabSyncBtn"
                                style="padding:8px 16px; background:rgba(255,170,0,0.2); border:1px solid rgba(255,170,0,0.4); color:#fa0; border-radius:6px; cursor:pointer;" title="Import open positions from your selected Schwab account">
                            üîÑ Sync Positions
                        </button>
                        <button onclick="syncSchwabTransactions()" 
                                id="schwabSyncTransactionsBtn"
                                style="padding:8px 16px; background:rgba(138,43,226,0.2); border:1px solid rgba(138,43,226,0.4); color:#a78bfa; border-radius:6px; cursor:pointer;"
                                title="Import closed trades from Schwab transaction history (last 90 days)">
                            üìú Sync Closed Trades
                        </button>
                        <button onclick="viewSchwabOrders()" 
                                style="padding:8px 16px; background:rgba(122,138,148,0.2); border:1px solid rgba(122,138,148,0.4); color:#a78bfa; border-radius:6px; cursor:pointer;" title="View recent orders sent to Schwab from WheelHouse">
                            üìã View Orders
                        </button>
                    </div>
                    <div id="schwabSyncStatus" style="margin-top:10px; font-size:12px; color:#888; display:none;"></div>
                    <div id="schwabTransactionSyncStatus" style="margin-top:5px; font-size:12px; color:#888;"></div>
                    
                    <!-- Orders Panel (hidden by default) -->
                    <div id="schwabOrdersPanel" style="display:none; margin-top:15px; padding:15px; background:rgba(0,0,0,0.3); border-radius:8px; border:1px solid #333;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="color:#a78bfa; margin:0;">üìã Recent Orders</h4>
                            <button onclick="refreshSchwabOrders()" style="padding:4px 10px; background:rgba(122,138,148,0.2); border:1px solid rgba(122,138,148,0.3); color:#a78bfa; border-radius:4px; cursor:pointer; font-size:11px;">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div id="schwabOrdersList" style="font-size:12px; color:#888;">
                            Loading orders...
                        </div>
                    </div>
                </div>
                
                <!-- OpenAI Section -->
                <div style="background:#1a1a2e; border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#7a8a94; margin:0;">
                            <span style="font-size:20px; margin-right:8px;">ü§ñ</span> OpenAI API
                        </h3>
                        <span id="openaiStatus" style="padding:4px 12px; border-radius:12px; font-size:11px; background:#333; color:#888;">
                            Not Configured
                        </span>
                    </div>
                    <p style="color:#aaa; font-size:12px; margin-bottom:15px;">
                        For AI-powered trade analysis (alternative to local Ollama).
                    </p>
                    
                    <div class="control-group" style="margin-bottom:15px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">API Key</label>
                        <input type="password" id="settingOpenAIKey" placeholder="sk-..." 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                    </div>
                    
                    <button onclick="testOpenAIConnection()" 
                            style="padding:8px 16px; background:rgba(122,138,148,0.2); border:1px solid rgba(122,138,148,0.4); color:#8a9aa8; border-radius:6px; cursor:pointer;" title="Verify OpenAI API key and send test request">
                        üîå Test Connection
                    </button>
                </div>
                
                <!-- Grok API Section -->
                <div style="background:#1a1a2e; border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#ff6b35; margin:0;">
                            <span style="font-size:20px; margin-right:8px;">üöÄ</span> Grok API (xAI)
                        </h3>
                        <span id="grokStatus" style="padding:4px 12px; border-radius:12px; font-size:11px; background:#333; color:#888;">
                            Not Configured
                        </span>
                    </div>
                    <p style="color:#aaa; font-size:12px; margin-bottom:15px;">
                        Fast cloud AI with real-time X/Twitter sentiment. Get your key from 
                        <a href="https://console.x.ai/" target="_blank" style="color:#ff6b35;">console.x.ai</a>
                    </p>
                    
                    <div class="control-group" style="margin-bottom:15px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">API Key</label>
                        <input type="password" id="settingGrokKey" placeholder="xai-..." 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                    </div>
                    
                    <button onclick="testGrokConnection()" 
                            style="padding:8px 16px; background:rgba(255,107,53,0.2); border:1px solid rgba(255,107,53,0.4); color:#ff6b35; border-radius:6px; cursor:pointer;" title="Verify xAI Grok API key and send test request">
                        üîå Test Connection
                    </button>
                </div>
                
                <!-- Ollama (Local AI) Section -->
                <div style="background:#1a1a2e; border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#22c55e; margin:0;">
                            <span style="font-size:20px; margin-right:8px;">ü¶ô</span> Ollama (Local AI)
                        </h3>
                        <span id="ollamaStatus" style="padding:4px 12px; border-radius:12px; font-size:11px; background:#333; color:#888;">
                            Checking...
                        </span>
                    </div>
                    <p style="color:#aaa; font-size:12px; margin-bottom:15px;">
                        Local AI models for analysis. Restart if models get stuck or crash.
                    </p>
                    
                    <div id="ollamaModelList" style="font-size:11px; color:#888; margin-bottom:15px;">
                        Loading models...
                    </div>
                    
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="window.checkOllamaStatus()" 
                                style="padding:8px 16px; background:rgba(34,197,94,0.2); border:1px solid rgba(34,197,94,0.4); color:#22c55e; border-radius:6px; cursor:pointer;" title="Check if Ollama is running and list installed models">
                            üîç Check Status
                        </button>
                        <button onclick="window.restartOllama()" 
                                style="padding:8px 16px; background:rgba(255,170,0,0.2); border:1px solid rgba(255,170,0,0.4); color:#ffaa00; border-radius:6px; cursor:pointer;" title="Restart Ollama service if models are stuck or crashed">
                            üîÑ Restart Ollama
                        </button>
                    </div>
                </div>
                
                <!-- Telegram Section -->
                <div style="background:#1a1a2e; border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="color:#0088cc; margin:0;">
                            <span style="font-size:20px; margin-right:8px;">üì±</span> Telegram Notifications
                        </h3>
                        <span id="telegramStatus" style="padding:4px 12px; border-radius:12px; font-size:11px; background:#333; color:#888;">
                            Not Configured
                        </span>
                    </div>
                    <p style="color:#aaa; font-size:12px; margin-bottom:15px;">
                        Receive trade alerts on Telegram. Create a bot via @BotFather.
                    </p>
                    
                    <div class="control-group" style="margin-bottom:12px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Bot Token</label>
                        <input type="password" id="settingTelegramToken" placeholder="123456789:ABC..." 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                    </div>
                    
                    <div class="control-group" style="margin-bottom:15px;">
                        <label style="display:block; font-size:11px; color:#888; margin-bottom:4px;">Chat ID</label>
                        <input type="text" id="settingTelegramChatId" placeholder="Your Telegram chat ID" 
                               style="width:100%; padding:10px; background:#0d0d1a; border:1px solid #444; border-radius:6px; color:#fff; font-family:monospace;">
                    </div>
                    
                    <button onclick="testTelegramConnection()" 
                            style="padding:8px 16px; background:rgba(0,136,204,0.2); border:1px solid rgba(0,136,204,0.4); color:#0df; border-radius:6px; cursor:pointer;" title="Send test message to your Telegram chat to verify bot is working">
                        üîå Test Connection
                    </button>
                </div>
                
                <!-- Save Button -->
                <div style="text-align:center; margin-top:30px;">
                    <button onclick="saveAllSettings()" 
                            style="padding:12px 40px; background:linear-gradient(135deg, #00ff88 0%, #00d9ff 100%); border:none; color:#0d0d1a; font-weight:bold; border-radius:8px; cursor:pointer; font-size:14px;" title="Save all API keys and settings to server .env file">
                        üíæ Save All Settings
                    </button>
                    <div id="settingsSaveStatus" style="margin-top:10px; font-size:12px; color:#888;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Broker Import Utility (loads before ES6 modules) -->
    <script src="js/broker-import.js"></script>
    
    <!-- Socket.IO Client for Real-time Streaming -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" crossorigin="anonymous"></script>
    
    <!-- Inline helpers for UI -->
    <script>
        // Toggle challenges section visibility in Portfolio tab
        function toggleChallengesSection() {
            const content = document.getElementById('challengesSectionContent');
            const toggle = document.getElementById('challengesToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }
    </script>
    
    <!-- Theme Settings (loads before modules) -->
    <script src="js/theme.js?v=1.19.92"></script>
    
    <!-- Schwab API Client -->
    <script src="js/schwab.js?v=1.19.92"></script>
    
    <!-- Settings Management -->
    <script src="js/settings.js?v=1.19.92"></script>
    
    <!-- Services (before ES6 modules) -->
    <script src="js/services/WeeklySummaryService.js?v=1.19.92"></script>
    
    <!-- Autonomous Trader Frontend -->
    <script src="js/autonomousTrader.js?v=1.19.93"></script>
    
    <!-- ES6 Module Entry Point -->
    <script type="module" src="js/main.js?v=1.19.92"></script>
</body>
</html>
